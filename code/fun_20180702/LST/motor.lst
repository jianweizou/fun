C51 COMPILER V9.54   MOTOR                                                                 02/16/2019 15:04:22 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MOTOR
OBJECT MODULE PLACED IN .\Output\motor.obj
COMPILER INVOKED BY: D:\keil\C51\BIN\C51.EXE Code\motor.c ROM(COMPACT) OPTIMIZE(8,SIZE) BROWSE INCDIR(..\..\Include;..\I
                    -nclude) DEFINE(FOSC_160000) DEBUG OBJECTEXTEND PRINT(.\LST\motor.lst) OBJECT(.\Output\motor.obj)

line level    source

   1          #include "N76E003.h"
   2          #include "SFR_Macro.h"
   3          #include "Function_define.h"
   4          #include "dataflash.h"
   5          #include "motor.h"
   6          
   7          
   8          unsigned char Motor_Level;
   9          extern bit BIT_TMP;
  10          bit isStartMotor;
  11          unsigned char Motor_done_cnt;
  12          
  13          void MOTOR_FG_PinInterrupt_ISR (void)
  14          {
  15   1              Motor_done_cnt = 0;
  16   1      }
  17          
  18          
  19          void InitPWM(void)
  20          {
  21   1              Motor_Level = 0;
  22   1      //    set_PWMRUN;       
  23   1              P12_OpenDrain_Mode;
  24   1              set_P0SR_0;
  25   1              P10_Input_Mode;
  26   1              P12 = 1;
  27   1              isStartMotor = 0;
  28   1              Motor_done_cnt = 0;
  29   1              
  30   1              P06_PushPull_Mode;
  31   1              P06 = 1;                        //CW
  32   1              P04_PushPull_Mode;      //motor power
  33   1              P04 = 0;
  34   1      }
  35          
  36          void TurnOffMotor(void)
  37          {
  38   1                      clr_EPI;
  39   1                      //turn off
  40   1                      Motor_Level = 0;
  41   1                      PWM0_P12_OUTPUT_DISABLE;
  42   1                      set_SFRPAGE;
  43   1                      PWM0H = 0x00;
  44   1                      PWM0L = 0x00;   
  45   1                      clr_SFRPAGE;
  46   1                      set_LOAD;
  47   1                      clr_CLRPWM;
  48   1                      //dispower
  49   1                      P12 = 1;        
  50   1                      isStartMotor = 0;
  51   1                      Motor_done_cnt = 0;
  52   1              
  53   1                      P04 = 0;
  54   1      }
C51 COMPILER V9.54   MOTOR                                                                 02/16/2019 15:04:22 PAGE 2   

  55          
  56          unsigned Change_Motor_PWM(void)
  57          {
  58   1              if (Motor_Level == 0)
  59   1              {
  60   2                      //enable FG ext interrupt
  61   2                      isStartMotor = 1;
  62   2                      PICON = 0x05;   //port1
  63   2                      PINEN  = 0x00;
  64   2                      PIPEN = 0x10;   //IO 4
  65   2                      set_EPI;                                                        // Enable pin interrupt
  66   2                      
  67   2                      Motor_Level = 1;
  68   2                      //pwm High
  69   2                      P12 = 0;
  70   2                      P04 = 1;
  71   2      //              set_SFRPAGE;
  72   2      //              PWM0H = 0x00;                                           
  73   2      //              PWM0L = 0xA6;   
  74   2      //              clr_SFRPAGE;
  75   2      //              set_LOAD;
  76   2      //              set_PWMRUN;                             
  77   2              }
  78   1              else if (Motor_Level == 1)
  79   1              {
  80   2                      Motor_Level = 2;
  81   2      
  82   2                      PWM0_P12_OUTPUT_ENABLE;
  83   2                      
  84   2                      PWM_IMDEPENDENT_MODE;
  85   2                      PWM_CLOCK_FSYS;
  86   2                      PWMPH = 0x03;
  87   2                      PWMPL = 0xE7;                                           //0x3E7 = 16KHZ,        0x290=24.46khz
  88   2                      set_SFRPAGE;                                            //PWM4 and PWM5 duty seting is in SFP page 1
  89   2                      PWM0H = 0x01;                                           
  90   2                      PWM0L = 0xF3;
  91   2                      clr_SFRPAGE;                            
  92   2                      set_LOAD;
  93   2                      
  94   2                      //pwm mid
  95   2                      set_SFRPAGE;
  96   2                      PWM0H = 0x00;                                           
  97   2                      PWM0L = 0xF0;   
  98   2                      clr_SFRPAGE;
  99   2                      set_LOAD;
 100   2                      set_PWMRUN;                     
 101   2              }
 102   1              else if (Motor_Level == 2)
 103   1              {
 104   2                      Motor_Level = 4;
 105   2                      //pwm low               
 106   2                      set_SFRPAGE;
 107   2                      PWM0H = 0x01;                                           
 108   2                      PWM0L = 0x80;   
 109   2                      clr_SFRPAGE;
 110   2                      set_LOAD;
 111   2                      set_PWMRUN;             
 112   2              }
 113   1      
 114   1              return Motor_Level;
 115   1      }
 116          
C51 COMPILER V9.54   MOTOR                                                                 02/16/2019 15:04:22 PAGE 3   

 117          unsigned char get_motor_level(void)
 118          {
 119   1              return Motor_Level;
 120   1      }
 121          
 122          unsigned char check_motor_done(void)
 123          {
 124   1              if (isStartMotor)
 125   1              {
 126   2                      if (Motor_done_cnt > 5)
 127   2                              return 1;
 128   2              }
 129   1              return 0;
 130   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    337    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      2    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
