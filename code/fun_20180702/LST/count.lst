C51 COMPILER V9.54   COUNT                                                                 06/11/2018 22:11:13 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE COUNT
OBJECT MODULE PLACED IN .\Output\count.obj
COMPILER INVOKED BY: D:\keil\C51\BIN\C51.EXE Code\count.c OPTIMIZE(8,SIZE) BROWSE INCDIR(..\..\Include;..\Include) DEFIN
                    -E(FOSC_160000) DEBUG OBJECTEXTEND PRINT(.\LST\count.lst) OBJECT(.\Output\count.obj)

line level    source

   1          #include "N76E003.h"
   2          #include "SFR_Macro.h"
   3          #include "count.h"
   4          #include "fontdata.h"
   5          #include "Function_define.h"
   6          #include "OLED.h"
   7          #include "dataflash.h"
   8          extern void Timer0_Init(void);
   9          extern void Timer1_Delay10ms(unsigned long cnt);
  10          #define KEYINPUTMODE    P17_Input_Mode;
  11          
  12          #define GETKEY          P17
  13          
  14          code unsigned char MONTH_DAY[]={31,28,31,30,31,30,31,31,30,31,30,31};
  15          
  16          unsigned char stage_loopcnt = 0;
  17          
  18          SysStruct       sysinfo;
  19          KEYTYPE keytype;
  20          
  21          unsigned char curKey,preKey;
  22          unsigned char debounce;
  23          unsigned int islongpress;
  24          unsigned char is_5ms_Flag;
  25          unsigned char blinktime;
  26          
  27          unsigned int powercnt;
  28          
  29          extern bit BIT_TMP;
  30          
  31          void KeyInit(void)
  32          {
  33   1              curKey = 0;
  34   1              preKey = 0;
  35   1              debounce = 0;
  36   1              islongpress = 0;
  37   1              keytype = 0;
  38   1              KEYINPUTMODE;
  39   1      }
  40          
  41          void KeyScan(void)
  42          {
  43   1              if (is_5ms_Flag)
  44   1              {
  45   2                      is_5ms_Flag = 0;
  46   2                      curKey = GETKEY;
  47   2                      if (curKey != preKey)
  48   2                      {
  49   3                              preKey = curKey;
  50   3                              if ((islongpress == 0)&&(debounce > 5))
  51   3                              {
  52   4                                      keytype = SHORTKEY;
  53   4                              }
  54   3                              else if (islongpress >= 12)
C51 COMPILER V9.54   COUNT                                                                 06/11/2018 22:11:13 PAGE 2   

  55   3                              {
  56   4                                      keytype = LONGKEY_12S;
  57   4                              }
  58   3                              else if (islongpress >= 5)
  59   3                              {
  60   4                                      keytype = LONGKEY_5S;
  61   4                              }
  62   3                              else if (islongpress >= 2)
  63   3                              {
  64   4                                      keytype = LONGKEY_2S;
  65   4                              }
  66   3                              debounce = 0;
  67   3                              islongpress = 0;
  68   3                              
  69   3                              powercnt = 0;
  70   3                      }
  71   2                      else if(curKey == 0)
  72   2                      {
  73   3                              debounce++;
  74   3                              if (debounce > 200)
  75   3                              {
  76   4                                      debounce = 0;
  77   4                                      islongpress++;
  78   4                              }
  79   3                              powercnt = 0;
  80   3                      }
  81   2              }
  82   1      }
  83          
  84          void display_Language_chinese(unsigned char isdisplay)
  85          {
  86   1              if (isdisplay == 1)
  87   1              {
  88   2                      Draw_BMP(16,0,16+16,2,(unsigned char *)(font_CHN + (ZHONG)*32));
  89   2                      Draw_BMP(32,0,32+16,2,font_CHN + (WEN)*32);
  90   2              }
  91   1              else
  92   1              {
  93   2                      OLED_CLS_Windows(16,0,48,2);
  94   2              }
  95   1      }
  96          void display_Language_english(unsigned char isdisplay)
  97          {
  98   1              char * en = "ENGLISH";
  99   1              char i;
 100   1              if (isdisplay == 1)
 101   1              {
 102   2                      for(i=0;i<7;i++)
 103   2                              Draw_BMP(4+8*i,2,4+8+8*i,4,font_A_Z + (en[i] - 'A')*16);
 104   2              }
 105   1              else
 106   1              {
 107   2                      OLED_CLS_Windows(4,2,60,4);
 108   2              }
 109   1      }
 110          void Select_Language(void)
 111          {
 112   1              if (sysinfo.isneedinitstage == 1)
 113   1              {
 114   2                      sysinfo.isneedinitstage = 0;
 115   2                      //init 
 116   2                      OLED_CLS_Windows(12,1,52,3);
C51 COMPILER V9.54   COUNT                                                                 06/11/2018 22:11:13 PAGE 3   

 117   2                      display_Language_chinese(1);
 118   2                      display_Language_english(1);            
 119   2              }
 120   1              if (keytype != NULLKEY)
 121   1              {
 122   2                      if (keytype == SHORTKEY)
 123   2                      {
 124   3                              if (stage_loopcnt == CHINESE)
 125   3                              {
 126   4                                      display_Language_chinese(1);
 127   4                                      stage_loopcnt = ENGLISH;
 128   4                              }
 129   3                              else
 130   3                              {
 131   4                                      display_Language_english(1);
 132   4                                      stage_loopcnt = CHINESE;        
 133   4                              }
 134   3                              sysinfo.language = stage_loopcnt;
 135   3                      }
 136   2                      else if (keytype >= LONGKEY_2S)
 137   2                      {
 138   3                              sysinfo.language = stage_loopcnt;
 139   3                              sysinfo.sysloop = SELECT_DATE;
 140   3                              stage_loopcnt = 0;
 141   3                              sysinfo.isneedinitstage = 1;
 142   3                              display_Language_english(0);
 143   3                              display_Language_chinese(0);
 144   3                      }
 145   2                      keytype = NULLKEY;
 146   2              }
 147   1              //blink
 148   1              if (blinktime == BLINK_H)
 149   1              {
 150   2                      if (sysinfo.language == CHINESE)
 151   2                              display_Language_chinese(0);
 152   2                      else
 153   2                              display_Language_english(0);
 154   2              }       
 155   1              else if (blinktime == (BLINK_H+BLINK_L))
 156   1              {
 157   2                      if (sysinfo.language == CHINESE)
 158   2                              display_Language_chinese(1);
 159   2                      else
 160   2                              display_Language_english(1);            
 161   2              }
 162   1      }
 163          
 164          
 165          unsigned int getdiv(unsigned long x,unsigned long y)
 166          {
 167   1              unsigned int div = 0;
 168   1              while(x >= y)
 169   1              {
 170   2                      div++;
 171   2                      x = x - y;
 172   2              }
 173   1              return div;
 174   1      }
 175          unsigned int getremainder(unsigned long x,unsigned long y)
 176          {
 177   1              while(x >= y)
 178   1              {
C51 COMPILER V9.54   COUNT                                                                 06/11/2018 22:11:13 PAGE 4   

 179   2                      x = x - y;
 180   2              }
 181   1              return x;
 182   1      }
 183          void display_date_year(unsigned char isdisplay)
 184          {
 185   1              unsigned char i;
 186   1              unsigned int  year;
 187   1              if (isdisplay == 1)
 188   1              {
 189   2                      year = BASEYEAR + sysinfo.sysdate.Year - 2000;
 190   2                      Draw_BMP(16,0,16+8,2,font2_0_9 + 16*2);//2
 191   2                      i = getdiv(year,100);
 192   2                      year = getremainder(year,100);
 193   2                      Draw_BMP(24,0,24+8,2,font2_0_9 + 16*i);//
 194   2                      i = getdiv(year,10);
 195   2                      year = getremainder(year,10);
 196   2                      Draw_BMP(32,0,32+8,2,font2_0_9 + 16*i);//
 197   2                      i= year;
 198   2                      Draw_BMP(40,0,40+8,2,font2_0_9 + 16*i);//2
 199   2              }
 200   1              else
 201   1              {
 202   2                      OLED_CLS_Windows(16,0,48,2);
 203   2              }
 204   1      }
 205          void display_date_month(unsigned char isdisplay)
 206          {
 207   1              unsigned char month;
 208   1              unsigned char i;
 209   1              if (isdisplay == 1)
 210   1              {
 211   2                      month = sysinfo.sysdate.Month;
 212   2                      i = getdiv(month,10);
 213   2                      month = getremainder(month,10);
 214   2                      Draw_BMP(12,2,12+8,4,font2_0_9 + 16*i);
 215   2                      i = month;
 216   2                      Draw_BMP(20,2,20+8,4,font2_0_9 + 16*i);
 217   2                      Draw_BMP(28,2,28+8,4,font2_0_9 + 16*10);// '/'
 218   2              }
 219   1              else
 220   1              {
 221   2                      OLED_CLS_Windows(12,2,28,4);
 222   2              }
 223   1      }
 224          void display_date_day(unsigned char isdisplay)
 225          {
 226   1              unsigned char day;
 227   1              unsigned char i;
 228   1              if (isdisplay == 1)
 229   1              {
 230   2                      day = sysinfo.sysdate.Day;
 231   2                      i = getdiv(day,10);
 232   2                      day = getremainder(day,10);
 233   2                      Draw_BMP(36,2,36+8,4,font2_0_9 + 16*i);
 234   2                      i = day;
 235   2                      Draw_BMP(44,2,44+8,4,font2_0_9 + 16*i);
 236   2              }
 237   1              else
 238   1              {
 239   2                      OLED_CLS_Windows(36,2,54,4);
 240   2              }
C51 COMPILER V9.54   COUNT                                                                 06/11/2018 22:11:13 PAGE 5   

 241   1      }
 242          void Select_Date(void)
 243          {
 244   1              unsigned char maxday;
 245   1              unsigned char year;
 246   1              if (sysinfo.isneedinitstage == 1)
 247   1              {
 248   2                      sysinfo.isneedinitstage = 0;
 249   2                      //init 
 250   2                      display_Language_chinese(0);
 251   2                      display_Language_english(0);
 252   2                      //date
 253   2                      display_date_year(1);
 254   2                      display_date_month(1);
 255   2                      display_date_day(1);
 256   2              }       
 257   1              if (keytype != NULLKEY)
 258   1              {
 259   2                      if (keytype == SHORTKEY)
 260   2                      {
 261   3                              if (stage_loopcnt == YEAR)
 262   3                                      sysinfo.sysdate.Year++;
 263   3                              else if (stage_loopcnt == MONTH)
 264   3                              {
 265   4                                      sysinfo.sysdate.Month++;
 266   4                                      if (sysinfo.sysdate.Month > 12)
 267   4                                              sysinfo.sysdate.Month = 1;
 268   4                              }
 269   3                              else if (stage_loopcnt == DAY)
 270   3                              {
 271   4                                      maxday = MONTH_DAY[sysinfo.sysdate.Month-1];
 272   4                                      sysinfo.sysdate.Day++;
 273   4                                      year = BASEYEAR + sysinfo.sysdate.Year;
 274   4                                      if((year%4==0&&year%100!=0)||(year%400==0))
 275   4                                      {
 276   5                                              if (sysinfo.sysdate.Month == 2)
 277   5                                                      maxday = 29;
 278   5                                      }
 279   4                                      if (sysinfo.sysdate.Day > maxday)
 280   4                                              sysinfo.sysdate.Day = 1;
 281   4                              }
 282   3                      }
 283   2                      else if (keytype >= LONGKEY_2S)
 284   2                      {
 285   3                              if (stage_loopcnt == DAY)
 286   3                              {
 287   4                                      sysinfo.sysloop = SELECT_NUMTYPE;
 288   4                                      sysinfo.isneedinitstage = 1;
 289   4                                      stage_loopcnt = 0;
 290   4                                      display_date_year(0);
 291   4                                      display_date_month(0);
 292   4                                      display_date_day(0);
 293   4                              }
 294   3                              else
 295   3                                      stage_loopcnt++;
 296   3                              if (stage_loopcnt == MONTH)
 297   3                                      display_date_year(1);
 298   3                              if (stage_loopcnt == DAY)
 299   3                              {
 300   4                                      display_date_month(1);
 301   4                              }
 302   3                      }
C51 COMPILER V9.54   COUNT                                                                 06/11/2018 22:11:13 PAGE 6   

 303   2                      keytype = NULLKEY;
 304   2              }
 305   1              //blink
 306   1              if (blinktime == BLINK_H)
 307   1              {
 308   2                      if (stage_loopcnt == YEAR)
 309   2                              display_date_year(0);
 310   2                      else if (stage_loopcnt == MONTH)
 311   2                              display_date_month(0);
 312   2                      else
 313   2                              display_date_day(0);
 314   2              }       
 315   1              else if (blinktime == (BLINK_H+BLINK_L))
 316   1              {
 317   2                      if (stage_loopcnt == YEAR)
 318   2                              display_date_year(1);
 319   2                      else if (stage_loopcnt == MONTH)
 320   2                              display_date_month(1);
 321   2                      else
 322   2                              display_date_day(1);    
 323   2              }
 324   1      }
 325          
 326          void display_cnt_stage_arabnum(unsigned char isdisplay)
 327          {
 328   1              char * nor = "NORMAL";
 329   1              char i;
 330   1              if (sysinfo.language == ENGLISH)
 331   1              {
 332   2                      if (isdisplay == 1)
 333   2                      {
 334   3                              for (i=0;i<6;i++)
 335   3                              {
 336   4                                      Draw_BMP(8 + i*8,0,8+8 + i*8,2,font_A_Z + (nor[i] - 'A')*16);
 337   4                              }
 338   3                      }
 339   2                      else
 340   2                      {
 341   3                              OLED_CLS_Windows(8,0,56,2);
 342   3                      }               
 343   2              }
 344   1              else
 345   1              {
 346   2                      if (isdisplay == 1)
 347   2                      {
 348   3                              Draw_BMP(16,0,16+16,2,font_CHN + (SHU)*32);
 349   3                              Draw_BMP(32,0,32+16,2,font_CHN + (ZI)*32);
 350   3                      }
 351   2                      else
 352   2                      {
 353   3                              OLED_CLS_Windows(16,0,48,2);
 354   3                      }
 355   2              }
 356   1      }
 357          void display_cnt_stage_tibnum(unsigned char isdisplay)
 358          {       
 359   1              char * nor = "TIBETAN";
 360   1              char i;
 361   1              if (sysinfo.language == ENGLISH)
 362   1              {
 363   2                      if (isdisplay == 1)
 364   2                      {
C51 COMPILER V9.54   COUNT                                                                 06/11/2018 22:11:13 PAGE 7   

 365   3                              for (i=0;i<7;i++)
 366   3                              {
 367   4                                      Draw_BMP(4+ i*8,2,8+4+ i*8,4,font_A_Z + (nor[i] - 'A')*16);
 368   4                              }
 369   3                      }
 370   2                      else
 371   2                      {
 372   3                              OLED_CLS_Windows(4,2,60,4);
 373   3                      }               
 374   2              }
 375   1              else
 376   1              {
 377   2                      if (isdisplay == 1)
 378   2                      {
 379   3                              Draw_BMP(0,2,0+16,4,font_CHN + (ZANG)*32);
 380   3                              Draw_BMP(16,2,16+16,4,font_CHN + (WEN)*32);             
 381   3                              Draw_BMP(32,2,16+32,4,font_CHN + (SHU)*32);
 382   3                              Draw_BMP(48,2,48+16,4,font_CHN + (ZI)*32);
 383   3                      }
 384   2                      else
 385   2                      {
 386   3                              OLED_CLS_Windows(0,2,64,4);
 387   3                      }
 388   2              }
 389   1      }
 390          void Select_NumType(void)
 391          {
 392   1              if (sysinfo.isneedinitstage == 1)
 393   1              {
 394   2                      sysinfo.isneedinitstage = 0;
 395   2                      display_cnt_stage_arabnum(1);
 396   2                      display_cnt_stage_tibnum(1);
 397   2              }       
 398   1              if (keytype != NULLKEY)
 399   1              {
 400   2                      if (keytype == SHORTKEY)
 401   2                      {
 402   3                              if (stage_loopcnt == TIBENUM)
 403   3                              {
 404   4                                      display_cnt_stage_tibnum(1);
 405   4                                      stage_loopcnt = ARABNUM;
 406   4                              }
 407   3                              else
 408   3                              {
 409   4                                      display_cnt_stage_arabnum(1);
 410   4                                      stage_loopcnt = TIBENUM;
 411   4                              }
 412   3                      }
 413   2                      else if (keytype >= LONGKEY_2S)
 414   2                      {
 415   3                              sysinfo.sysloop = CNT_STAGE;
 416   3                              sysinfo.numtype = stage_loopcnt;
 417   3                              stage_loopcnt = 0;
 418   3                              sysinfo.isneedinitstage = 1;
 419   3                              display_cnt_stage_arabnum(0);
 420   3                              display_cnt_stage_tibnum(0);                    
 421   3                      }
 422   2                      keytype = NULLKEY;
 423   2              }
 424   1              //blink
 425   1              if (blinktime == BLINK_H)
 426   1              {
C51 COMPILER V9.54   COUNT                                                                 06/11/2018 22:11:13 PAGE 8   

 427   2                      if (stage_loopcnt == TIBENUM)
 428   2                              display_cnt_stage_tibnum(0);
 429   2                      else if (stage_loopcnt == ARABNUM)
 430   2                              display_cnt_stage_arabnum(0);
 431   2              }       
 432   1              else if (blinktime == (BLINK_H+BLINK_L))
 433   1              {
 434   2                      if (stage_loopcnt == TIBENUM)
 435   2                              display_cnt_stage_tibnum(1);
 436   2                      else if (stage_loopcnt == ARABNUM)
 437   2                              display_cnt_stage_arabnum(1);
 438   2              }       
 439   1      }
 440          
 441          void display_cnt_stage_date(unsigned char isdisplay)
 442          {
 443   1              unsigned int temp;
 444   1              unsigned char i;
 445   1              if (isdisplay == 1)
 446   1              {
 447   2                      temp = sysinfo.sysdate.Day;
 448   2                      i = getdiv(temp,10);
 449   2                      temp = getremainder(temp,10);
 450   2                      Draw_BMP(52,0,58,1,font1_0_9 + 6*i);
 451   2                      i = temp;
 452   2                      Draw_BMP(58,0,64,1,font1_0_9 + 6*i);
 453   2                      
 454   2                      // '/'
 455   2                      Draw_BMP(46,0,52,1,font1_0_9 + 6*10);
 456   2                      
 457   2                      temp = sysinfo.sysdate.Month;
 458   2                      i = getdiv(temp,10);
 459   2                      temp = getremainder(temp,10);
 460   2                      Draw_BMP(34,0,40,1,font1_0_9 + 6*i);
 461   2                      i = temp;
 462   2                      Draw_BMP(40,0,46,1,font1_0_9 + 6*i);
 463   2      
 464   2                      // '/'
 465   2                      Draw_BMP(28,0,34,1,font1_0_9 + 6*10);
 466   2                      
 467   2                      temp = BASEYEAR + sysinfo.sysdate.Year - 2000;
 468   2                      Draw_BMP(4,0,10,1,font1_0_9 + 6*2);//2
 469   2                      i = getdiv(temp,100);
 470   2                      temp = getremainder(temp,100);
 471   2                      Draw_BMP(10,0,16,1,font1_0_9 + 6*i);//
 472   2                      i = getdiv(temp,10);
 473   2                      temp = getremainder(temp,10);
 474   2                      Draw_BMP(16,0,22,1,font1_0_9 + 6*i);//
 475   2                      i= temp;
 476   2                      Draw_BMP(22,0,28,1,font1_0_9 + 6*i);//2         
 477   2              }
 478   1              else
 479   1              {
 480   2                      OLED_CLS_Windows(4,0,64,2);
 481   2              }
 482   1      }
 483          
 484          
 485          void display_cnt_stage_cnt(unsigned long cnt,unsigned char isdisplay)
 486          {
 487   1              unsigned char i;
 488   1              unsigned long temp;
C51 COMPILER V9.54   COUNT                                                                 06/11/2018 22:11:13 PAGE 9   

 489   1              unsigned char nextdisplay=0; 
 490   1              if (isdisplay == 0)
 491   1              {
 492   2                      OLED_CLS_Windows(0,2,64,4);
 493   2                      return;
 494   2              }
 495   1              temp = cnt;
 496   1              if (sysinfo.numtype == ARABNUM)
 497   1              {
 498   2                      i = getdiv(temp,10000);
 499   2                      temp = getremainder(temp,10000);
 500   2                      if (i != 0)
 501   2                      {
 502   3                              Draw_BMP(12,2,12+8,4,font2_0_9 + 16*i);
 503   3                              nextdisplay = 1;
 504   3                      }
 505   2                      
 506   2                      i = getdiv(temp,1000);
 507   2                      temp = getremainder(temp,1000);
 508   2                      if ((nextdisplay == 1)||(i != 0))
 509   2                      {
 510   3                              nextdisplay = 1;
 511   3                              Draw_BMP(20,2,20+8,4,font2_0_9 + 16*i);
 512   3                      }
 513   2                      
 514   2                      i = getdiv(temp,100);
 515   2                      temp = getremainder(temp,100);
 516   2                      if ((nextdisplay == 1)||(i != 0))
 517   2                      {
 518   3                              nextdisplay = 1;
 519   3                              Draw_BMP(28,2,28+8,4,font2_0_9 + 16*i);
 520   3                      }
 521   2                      
 522   2                      i = getdiv(temp,10);
 523   2                      temp = getremainder(temp,10);
 524   2                      if ((nextdisplay == 1)||(i != 0))
 525   2                      {
 526   3                              nextdisplay = 1;
 527   3                              Draw_BMP(36,2,36+8,4,font2_0_9 + 16*i);
 528   3                      }
 529   2                      
 530   2                      i = temp;
 531   2                      Draw_BMP(44,2,44+8,4,font2_0_9 + 16*i);
 532   2              }
 533   1              else
 534   1              {
 535   2                      i = getdiv(temp,10000);
 536   2                      temp = getremainder(temp,10000);
 537   2                      if (i != 0)
 538   2                      {
 539   3                              Draw_BMP(1,2,1+12,4,t0 + 24*i);
 540   3                              nextdisplay = 1;
 541   3                      }
 542   2                      
 543   2                      i = getdiv(temp,1000);
 544   2                      temp = getremainder(temp,1000);
 545   2                      if ((nextdisplay == 1)||(i != 0))
 546   2                      {
 547   3                              Draw_BMP(13,2,13+12,4,t0 + 24*i);
 548   3                              nextdisplay = 1;
 549   3                      }
 550   2                      
C51 COMPILER V9.54   COUNT                                                                 06/11/2018 22:11:13 PAGE 10  

 551   2                      i = getdiv(temp,100);
 552   2                      temp = getremainder(temp,100);
 553   2                      if ((nextdisplay == 1)||(i != 0))
 554   2                      {
 555   3                              Draw_BMP(25,2,25+12,4,t0 + 24*i);
 556   3                              nextdisplay = 1;
 557   3                      }
 558   2                      
 559   2                      i = getdiv(temp,10);
 560   2                      temp = getremainder(temp,10);
 561   2                      if ((nextdisplay == 1)||(i != 0))
 562   2                      {
 563   3                              Draw_BMP(37,2,37+12,4,t0 + 24*i);
 564   3                              nextdisplay = 1;
 565   3                      }
 566   2                      i = temp;
 567   2                      Draw_BMP(49,2,49+12,4,t0 + 24*i);               
 568   2              }
 569   1      }
 570          void Cnt_Stage(void)
 571          {               
 572   1              if (sysinfo.isneedinitstage == 1)
 573   1              {
 574   2                      sysinfo.isneedinitstage = 0;            
 575   2                      display_cnt_stage_date(1);
 576   2                      display_cnt_stage_cnt(sysinfo.totalcnt,1);
 577   2              }
 578   1              
 579   1      //      if (powercnt == 20)
 580   1      //      {
 581   1      //              powercnt = 0;
 582   1      //              sysinfo.totalcnt++;
 583   1      //              if (sysinfo.totalcnt > 99999)
 584   1      //                              sysinfo.totalcnt = 0;
 585   1      //              display_cnt_stage_cnt(sysinfo.totalcnt,1);
 586   1      //      }
 587   1              
 588   1              if (keytype != NULLKEY)
 589   1              {
 590   2                      if (keytype == SHORTKEY)
 591   2                      {
 592   3                              sysinfo.totalcnt++;
 593   3                              if (sysinfo.totalcnt > 99999)
 594   3                                      sysinfo.totalcnt = 0;
 595   3                              display_cnt_stage_cnt(sysinfo.totalcnt,1);
 596   3                      }
 597   2                      else if (keytype == LONGKEY_5S)
 598   2                      {
 599   3                              sysinfo.sysloop = RST_CNT;
 600   3                              sysinfo.isneedinitstage = 1;
 601   3                              stage_loopcnt = 0;
 602   3                              display_cnt_stage_date(0);
 603   3                              display_cnt_stage_cnt(0,0);                     
 604   3                      }
 605   2                      else if (keytype == LONGKEY_12S)
 606   2                      {
 607   3                              sysinfo.sysloop = RST_SYS;
 608   3                              sysinfo.isneedinitstage = 1;
 609   3                              stage_loopcnt = 0;
 610   3                              display_cnt_stage_date(0);
 611   3                              display_cnt_stage_cnt(0,0);                     
 612   3                      }
C51 COMPILER V9.54   COUNT                                                                 06/11/2018 22:11:13 PAGE 11  

 613   2                      keytype = NULLKEY;
 614   2              }
 615   1      }
 616          
 617          
 618          void display_rst_cnt_stage_1(unsigned char isdisplay)
 619          {
 620   1              char i;
 621   1              char * en = "RST";
 622   1              char * en1 = "CNT";
 623   1              if (sysinfo.language == ENGLISH)
 624   1              {
 625   2                      if (isdisplay == 1)
 626   2                      {
 627   3                              for (i=0;i<3;i++)
 628   3                              {
 629   4                                      Draw_BMP(6+i*8,0,8+6 + i*8,2,font_A_Z + (en[i]-'A')*16);
 630   4                                      Draw_BMP(32+ i*8,0,8+32+ i*8,2,font_A_Z + (en1[i]-'A')*16);
 631   4                              }
 632   3                      }
 633   2                      else
 634   2                      {
 635   3                              OLED_CLS_Windows(6,0,56,2);
 636   3                      }               
 637   2              }
 638   1              else
 639   1              {
 640   2                      if (isdisplay == 1)
 641   2                      {
 642   3                              Draw_BMP(16,0,16+16,2,font_CHN + (GUI)*32);
 643   3                              Draw_BMP(32,0,32+16,2,font_CHN + (LING)*32);
 644   3                      }
 645   2                      else
 646   2                      {
 647   3                              OLED_CLS_Windows(16,0,48,2);
 648   3                      }
 649   2              }
 650   1      }
 651          void display_rst_cnt_stage_yes(unsigned char isdisplay)
 652          {
 653   1              char i;
 654   1              char * en = "YES";
 655   1              if (sysinfo.language == ENGLISH)
 656   1              {
 657   2                      if (isdisplay == 1)
 658   2                      {
 659   3                              for (i=0;i<3;i++)
 660   3                              {
 661   4                                      Draw_BMP(10+i*8,2,8+10 + i*8,4,font_A_Z + (en[i]-'A')*16);
 662   4                              }
 663   3                      }
 664   2                      else
 665   2                      {
 666   3                              OLED_CLS_Windows(10,2,34,4);
 667   3                      }               
 668   2              }
 669   1              else    
 670   1              {
 671   2                      if (isdisplay == 1)
 672   2                      {
 673   3                              Draw_BMP(12,2,12+16,4,font_CHN + (SHI)*32);
 674   3                      }
C51 COMPILER V9.54   COUNT                                                                 06/11/2018 22:11:13 PAGE 12  

 675   2                      else
 676   2                      {
 677   3                              OLED_CLS_Windows(12,2,28,4);
 678   3                      }       
 679   2              }
 680   1      }
 681          void display_rst_cnt_stage_no(unsigned char isdisplay)
 682          {
 683   1              char i;
 684   1              char * en = "NO";
 685   1              if (sysinfo.language == ENGLISH)
 686   1              {
 687   2                      if (isdisplay == 1)
 688   2                      {
 689   3                              for (i=0;i<2;i++)
 690   3                              {
 691   4                                      Draw_BMP(38+i*8,2,8+38 + i*8,4,font_A_Z + (en[i]-'A')*16);
 692   4                              }
 693   3                      }
 694   2                      else
 695   2                      {
 696   3                              OLED_CLS_Windows(38,2,54,4);
 697   3                      }               
 698   2              }
 699   1              else    
 700   1              {       
 701   2                      if (isdisplay == 1)
 702   2                      {
 703   3                              Draw_BMP(36,2,36+16,4,font_CHN + (FOU)*32);
 704   3                      }
 705   2                      else
 706   2                      {
 707   3                              OLED_CLS_Windows(36,2,52,4);
 708   3                      }
 709   2              }       
 710   1      }
 711          void Rst_Cnt_Stage(void)
 712          {
 713   1              if (sysinfo.isneedinitstage == 1)
 714   1              {
 715   2                      sysinfo.isneedinitstage = 0;
 716   2                      display_rst_cnt_stage_1(1);
 717   2                      display_rst_cnt_stage_yes(1);
 718   2                      display_rst_cnt_stage_no(1);
 719   2              }
 720   1              if (keytype != NULLKEY)
 721   1              {
 722   2                      if (keytype == SHORTKEY)
 723   2                      {
 724   3                              if (stage_loopcnt == YES)
 725   3                              {
 726   4                                      display_rst_cnt_stage_yes(1);
 727   4                                      stage_loopcnt = NO;
 728   4                              }
 729   3                              else
 730   3                              {
 731   4                                      stage_loopcnt = YES;
 732   4                                      display_rst_cnt_stage_no(1);
 733   4                              }
 734   3                      }
 735   2                      else if (keytype >= LONGKEY_2S)
 736   2                      {
C51 COMPILER V9.54   COUNT                                                                 06/11/2018 22:11:13 PAGE 13  

 737   3                              if (stage_loopcnt == 0)//yes
 738   3                                      sysinfo.totalcnt = 0;
 739   3                              sysinfo.sysloop = CNT_STAGE;
 740   3                              stage_loopcnt = 0;
 741   3                              sysinfo.isneedinitstage = 1;
 742   3                              display_rst_cnt_stage_1(0);
 743   3                              display_rst_cnt_stage_yes(0);
 744   3                              display_rst_cnt_stage_no(0);                    
 745   3                      }
 746   2                      keytype = NULLKEY;
 747   2              }
 748   1              //blink
 749   1              if (blinktime == BLINK_H)
 750   1              {
 751   2                      if (stage_loopcnt == YES)
 752   2                              display_rst_cnt_stage_yes(0);
 753   2                      else if (stage_loopcnt == NO)
 754   2                              display_rst_cnt_stage_no(0);
 755   2              }       
 756   1              else if (blinktime == (BLINK_H+BLINK_L))
 757   1              {
 758   2                      if (stage_loopcnt == YES)
 759   2                              display_rst_cnt_stage_yes(1);
 760   2                      else if (stage_loopcnt == NO)
 761   2                              display_rst_cnt_stage_no(1);
 762   2              }       
 763   1      }
 764          
 765          void display_rst_sys_stage_1(unsigned char isdisplay)
 766          {
 767   1              char i;
 768   1              char * en = "RST";
 769   1              char * en1 = "DEV";
 770   1              if (sysinfo.language == ENGLISH)
 771   1              {
 772   2                      if (isdisplay == 1)
 773   2                      {
 774   3                              for (i=0;i<3;i++)
 775   3                              {
 776   4                                      Draw_BMP(6+i*8,0,8+6 + i*8,2,font_A_Z + (en[i]-'A')*16);
 777   4                                      Draw_BMP(32+ i*8,0,8+32+ i*8,2,font_A_Z + (en1[i]-'A')*16);
 778   4                              }
 779   3                      }
 780   2                      else
 781   2                      {
 782   3                              OLED_CLS_Windows(6,0,56,2);
 783   3                      }               
 784   2              }
 785   1              else
 786   1              {       
 787   2                      if (isdisplay == 1)
 788   2                      {
 789   3                              Draw_BMP(16,0,16+16,2,font_CHN + (CHONG)*32);
 790   3                              Draw_BMP(32,0,32+16,2,font_CHN + (ZHI)*32);
 791   3                      }
 792   2                      else
 793   2                      {
 794   3                              OLED_CLS_Windows(16,0,48,2);
 795   3                      }
 796   2              }
 797   1      }
 798          
C51 COMPILER V9.54   COUNT                                                                 06/11/2018 22:11:13 PAGE 14  

 799          void Rst_Sys_Stage(void)
 800          {
 801   1              if (sysinfo.isneedinitstage == 1)
 802   1              {
 803   2                      sysinfo.isneedinitstage = 0;
 804   2                      display_rst_sys_stage_1(1);
 805   2                      display_rst_cnt_stage_yes(1);
 806   2                      display_rst_cnt_stage_no(1);            
 807   2              }
 808   1              if (keytype != NULLKEY)
 809   1              {
 810   2                      if (keytype == SHORTKEY)
 811   2                      {
 812   3                              if (stage_loopcnt == YES)
 813   3                              {
 814   4                                      display_rst_cnt_stage_yes(1);
 815   4                                      stage_loopcnt = NO;
 816   4                              }
 817   3                              else
 818   3                              {
 819   4                                      stage_loopcnt = YES;
 820   4                                      display_rst_cnt_stage_no(1);    
 821   4                              }
 822   3                      }
 823   2                      else if (keytype >= LONGKEY_2S)
 824   2                      {
 825   3                              display_rst_sys_stage_1(0);
 826   3                              display_rst_cnt_stage_yes(0);   
 827   3                              display_rst_cnt_stage_no(0);    
 828   3                              if (stage_loopcnt == 0)
 829   3                              {
 830   4                                      sysinfo.sysloop = SYSINIT;
 831   4                              }
 832   3                              else
 833   3                                      sysinfo.sysloop = CNT_STAGE;
 834   3                              stage_loopcnt = 0;
 835   3                              sysinfo.isneedinitstage = 1;
 836   3                      }
 837   2                      keytype = NULLKEY;
 838   2              }
 839   1              //blink
 840   1              if (blinktime == BLINK_H)
 841   1              {
 842   2                      if (stage_loopcnt == YES)
 843   2                              display_rst_cnt_stage_yes(0);
 844   2                      else if (stage_loopcnt == NO)
 845   2                              display_rst_cnt_stage_no(0);
 846   2              }       
 847   1              else if (blinktime == (BLINK_H+BLINK_L))
 848   1              {
 849   2                      if (stage_loopcnt == YES)
 850   2                              display_rst_cnt_stage_yes(1);
 851   2                      else if (stage_loopcnt == NO)
 852   2                              display_rst_cnt_stage_no(1);
 853   2              }               
 854   1      }
 855          
 856          void SysLoop(void)
 857          {
 858   1              switch(sysinfo.sysloop)
 859   1              {
 860   2                      case SELECT_LANGUAGE:
C51 COMPILER V9.54   COUNT                                                                 06/11/2018 22:11:13 PAGE 15  

 861   2                              Select_Language();
 862   2                              break;
 863   2                      case SELECT_DATE:
 864   2                              Select_Date();
 865   2                              break;
 866   2                      case SELECT_NUMTYPE:
 867   2                              Select_NumType();
 868   2                              break;
 869   2                      case CNT_STAGE:
 870   2                              Cnt_Stage();
 871   2                              break;
 872   2                      case RST_CNT:
 873   2                              Rst_Cnt_Stage();
 874   2                              break;
 875   2                      case RST_SYS:
 876   2                              Rst_Sys_Stage();
 877   2                              break;
 878   2                      default:break;
 879   2              }
 880   1      }
 881          void PinInterrupt_ISR (void) interrupt 7
 882          {
 883   1              PIF = 0;
 884   1      }
 885          
 886          void Enter_DPD(void)
 887          {
 888   1              //…Ë÷√P17∞¥º¸ªΩ–—
 889   1          P17_Input_Mode;
 890   1              set_P0S_7;
 891   1              Enable_INT_Port1;
 892   1              Enable_BIT7_FallEdge_Trig;
 893   1          set_EPI;                                                    // Enable pin interrupt
 894   1          set_EA;                     
 895   1              //dpd
 896   1              set_PD;
 897   1              
 898   1              PICON  = PICON & 0xFE;
 899   1      }
 900          
 901          void main_loop(void)
 902          {
 903   1              KeyInit();
 904   1              OLED_Init();
 905   1              OLED_Clear();
 906   1              //read sys struct from ldrom
 907   1              getdata(13,DATA_START_ADDR,(unsigned char *)&sysinfo);
 908   1              stage_loopcnt = 0;
 909   1              sysinfo.isdpd = 0;
 910   1              sysinfo.isneedinitstage = 1;
 911   1              powercnt = 0;
 912   1              while(1)
 913   1              {
 914   2                      KeyScan();
 915   2                      
 916   2                      if ((sysinfo.isinitsys != 0xA5)||(sysinfo.sysloop == SYSINIT))
 917   2                      {
 918   3                              //clr sysinfo
 919   3                              sysinfo.language = CHINESE;
 920   3                              sysinfo.numtype = ARABNUM;
 921   3                              sysinfo.sysdate.Year = 0;
 922   3                              sysinfo.sysdate.Month = 1;
C51 COMPILER V9.54   COUNT                                                                 06/11/2018 22:11:13 PAGE 16  

 923   3                              sysinfo.sysdate.Day = 1;
 924   3                              sysinfo.totalcnt = 0;
 925   3                              sysinfo.isinitsys = 0xA5;
 926   3                              sysinfo.sysloop = SELECT_LANGUAGE;
 927   3                              sysinfo.isdpd = 0;
 928   3                              //Display power on stage
 929   3                              OLED_Set_Pos(7,1);
 930   3                              Draw_BMP(12,1,12+8,3,font_A_Z + ('K' - 'A')*16);
 931   3                              Draw_BMP(20,1,20+16,3,font_CHN + (SAN)*32);
 932   3                              Draw_BMP(36,1,36+8,3,font_A_Z + ('W' - 'A')*16);
 933   3                              Draw_BMP(44,1,44+8,3,font_A_Z + ('A' - 'A')*16);
 934   3                              
 935   3                              powercnt = 0;
 936   3                              while(powercnt<400);
 937   3                              powercnt=0;
 938   3                              sysinfo.isneedinitstage = 1;
 939   3                              
 940   3                              OLED_CLS_Windows(12,1,52,3);
 941   3                      }
 942   2                      if (sysinfo.isdpd == 0)
 943   2                              SysLoop();
 944   2                      else
 945   2                      {
 946   3                              if (keytype != NULLKEY)
 947   3                              {
 948   4                                      keytype = NULLKEY;
 949   4                                      //reinit oled
 950   4                                      sysinfo.isdpd = 0;
 951   4                                      OLED_Display_On();
 952   4                              }
 953   3                      }
 954   2                      
 955   2                      //power mode
 956   2                      if (powercnt == POWER_CNT1)
 957   2                      {
 958   3                              //close OLED
 959   3                              OLED_Display_Off();
 960   3                              sysinfo.isdpd = 1;
 961   3                              //display off
 962   3      //              }
 963   3      //              else if (powercnt == POWER_CNT2)
 964   3      //              {
 965   3                              //OLED power down
 966   3                              //save DATA 
 967   3                              savedata(13,DATA_START_ADDR,(unsigned char *)&sysinfo);
 968   3                              //enter dpd close device
 969   3                              Enter_DPD();
 970   3                              powercnt = 0;
 971   3                              return;
 972   3                      }
 973   2              }
 974   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   4844    ----
   CONSTANT SIZE    =     54    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     24      77
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
C51 COMPILER V9.54   COUNT                                                                 06/11/2018 22:11:13 PAGE 17  

END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
