C51 COMPILER V9.54   MAIN                                                                  05/21/2019 21:08:38 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Output\main.obj
COMPILER INVOKED BY: D:\keil\C51\BIN\C51.EXE Code\main.c ROM(COMPACT) OPTIMIZE(8,SIZE) BROWSE INCDIR(..\..\Include;..\In
                    -clude) DEFINE(FOSC_160000) DEBUG OBJECTEXTEND PRINT(.\LST\main.lst) OBJECT(.\Output\main.obj)

line level    source

   1          
   2          #include "N76E003.h"
   3          #include "SFR_Macro.h"
   4          #include "Function_define.h"
   5          #include "dataflash.h"
   6          #include "key.h"
   7          #include "motor.h"
   8          #include "led.h"
   9          
  10          #define TH0_INIT        (65536-6667)/256 //5.0ms@XTAL=12MHz, Period = (10.85/2) ms@XTAL=22.1184MHz
  11          #define TL0_INIT        (65536-6667)%256
  12          #define TH1_INIT        0xE0 //2.5ms@XTAL=12MHz, Period = (5.425/2) ms@XTAL=22.1184MHz
  13          #define TL1_INIT        0x00
  14          
  15          bit BIT_TMP;
  16          
  17          unsigned char is_5ms_Flag;
  18          unsigned int dpdtime;
  19          #define ADC_CNT 8
  20          unsigned char adccnt;
  21          unsigned int adc[ADC_CNT];
  22          unsigned char batlevel;
  23          unsigned int batlevelledtimeout;
  24          unsigned int adcvalue;
  25          extern unsigned char Motor_Level;
  26          extern unsigned int led_display_time;
  27          /********************************/
  28          #define Stage_A         1
  29          #define Stage_B         2
  30          #define Stage_C         4
  31          #define Stage_D         8
  32          
  33          unsigned char system_stage;
  34          bit isneedinitstage;
  35          bit isneedinitsys;
  36          bit ischarging;
  37          bit isstartsystem;
  38          unsigned char startADC_cnt;
  39          unsigned char batlevel_led_value;
  40          unsigned char adc_pre_cnt;
  41          /*******************************/
  42          
  43          
  44          /*********************************************************************************************************
             -***
  45          *    TIMER 0 interrupt subroutine
  46          **********************************************************************************************************
             -**/
  47          void Timer0_ISR (void) interrupt 1          //interrupt address is 0x000B
  48          {
  49   1          TH0 = TH0_INIT;
  50   1          TL0 = TL0_INIT;
  51   1              is_5ms_Flag = 1;
  52   1              dpdtime++;
C51 COMPILER V9.54   MAIN                                                                  05/21/2019 21:08:38 PAGE 2   

  53   1              startADC_cnt ++;
  54   1              led_display_time++;
  55   1              if (isStartMotor)
  56   1                      Motor_done_cnt++;
  57   1      }
  58          
  59          void Timer0_Init(void)
  60          {
  61   1              TMOD = 0XFF;
  62   1              TIMER0_MODE1_ENABLE;                        //Timer 0  mode configuration
  63   1          
  64   1              clr_T0M;
  65   1          
  66   1              TH0 = TH0_INIT;
  67   1              TL0 = TL0_INIT;
  68   1          
  69   1              set_ET0;                                    //enable Timer0 interrupt
  70   1              set_EA;                                     //enable interrupts
  71   1              
  72   1              set_TR0;                                    //Timer0 run
  73   1      }
  74          
  75          unsigned int getadcvalue(void)
  76          {
  77   1              unsigned char i;
  78   1              unsigned int adcvalue;
  79   1              adcvalue = 0;
  80   1              for(i=0;i<ADC_CNT;i++)
  81   1              {
  82   2                      adcvalue += adc[i];
  83   2              }
  84   1              adcvalue >>=3;
  85   1              return adcvalue;
  86   1      }
  87          
  88          
  89          unsigned char getbatlevel(unsigned char adc_delay)
  90          {
  91   1              unsigned char templevel;
  92   1              unsigned char i;
  93   1              unsigned char cur_pwm_level;
  94   1              if (startADC_cnt > adc_delay)
  95   1              {
  96   2                      startADC_cnt = 0;
  97   2                      clr_ADCF;
  98   2                      set_ADCS;                                                                       // ADC start trig signal
  99   2                      while(ADCF == 0);
 100   2                      adcvalue = ADCRH;
 101   2                      adcvalue <<= 4;
 102   2                      adcvalue |= ADCRL&0x0F;
 103   2                      adc[adccnt] = adcvalue;
 104   2                      adccnt++;
 105   2                      if (adccnt >= ADC_CNT)
 106   2                      {
 107   3                              adccnt = 0;
 108   3                              adcvalue = getadcvalue();
 109   3                              i = get_motor_level();
 110   3                              if (i == 1)
 111   3                              {
 112   4                                      cur_pwm_level = cur_pwm();
 113   4                                      if (cur_pwm_level == 1)
 114   4                                              adcvalue = adcvalue + 0x08;
C51 COMPILER V9.54   MAIN                                                                  05/21/2019 21:08:38 PAGE 3   

 115   4                                      else if (cur_pwm_level == 2)
 116   4                                              adcvalue = adcvalue + 0x10;
 117   4                                      else
 118   4                                              adcvalue = adcvalue + 0x20;
 119   4                              }
 120   3                              else if (i == 2)
 121   3                              {
 122   4                                      adcvalue = adcvalue + 0x10;
 123   4                              }
 124   3                              else if (i == 4)
 125   3                              {
 126   4                                      adcvalue = adcvalue + 0x08;
 127   4                              }
 128   3                              if (ischarging)
 129   3                              {
 130   4                                      if (batlevel < 3)
 131   4                                              adcvalue = adcvalue - 0x50;
 132   4                                      else if (batlevel < 5)
 133   4                                              adcvalue = adcvalue - 0x40;
 134   4                                      else
 135   4                                              adcvalue = adcvalue - 0x30;     //0x90 -> 0.3v
 136   4                              }
 137   3                              if (adcvalue > 0xD20)           //100% 8.2
 138   3                              {
 139   4                                      templevel = 6;
 140   4                              }
 141   3                              else if (adcvalue > 0xCB0)      //>75%  8v              
 142   3                              {
 143   4                                      templevel = 5;
 144   4                              }
 145   3                              else if (adcvalue > 0xC40)      //>50%  7.7v
 146   3                              {
 147   4                                      templevel = 4;
 148   4                              }
 149   3                              else if (adcvalue > 0xBE0)      //>25%  7.5
 150   3                              {
 151   4                                      templevel = 3;
 152   4                              }
 153   3                              else if (adcvalue > 0xBA0)      //10%   7.2v
 154   3                              {
 155   4                                      templevel = 2;
 156   4                              }
 157   3                              else
 158   3                              {
 159   4                                      templevel = 1;
 160   4                              }
 161   3                              if (batlevel != templevel)
 162   3                                      adc_pre_cnt++;
 163   3                              else
 164   3                                      adc_pre_cnt = 0;
 165   3                              if (adc_pre_cnt > 4)
 166   3                              {
 167   4                                      adc_pre_cnt = 0;
 168   4                                      batlevel = templevel;
 169   4                              }
 170   3                              return 1;
 171   3                      }
 172   2              }       
 173   1              return 0;
 174   1      }
 175          
 176          
C51 COMPILER V9.54   MAIN                                                                  05/21/2019 21:08:38 PAGE 4   

 177          void SysInit(void)
 178          {
 179   1              Init_LED();
 180   1              Timer0_Init();  
 181   1              startADC_cnt = 0;
 182   1              adccnt = 0;
 183   1              KeyInit();      
 184   1              InitPWM();
 185   1              system_stage = Stage_A;
 186   1              isneedinitstage = 1;
 187   1              batlevelledtimeout = 0; 
 188   1              batlevel_led_value = 0;
 189   1              ischarging = 0;
 190   1              adc_pre_cnt = 0;
 191   1              Enable_ADC_AIN2;
 192   1              if (isstartsystem == 0)
 193   1              {
 194   2                      while(dpdtime<60)
 195   2                      {
 196   3                              getbatlevel(0);
 197   3                      }
 198   2                      isstartsystem = 1;
 199   2              }
 200   1              else
 201   1              {
 202   2                      while(dpdtime<20)
 203   2                      {
 204   3                              getbatlevel(1);
 205   3                      }               
 206   2              }
 207   1              dpdtime = 0;
 208   1              led_display_time = 0;
 209   1              startADC_cnt = 0;
 210   1      }
 211          
 212          void P05_wakeup_init(void){
 213   1              P05_Input_Mode;
 214   1              
 215   1              PINEN = 0x20;
 216   1              PIPEN = 0x00;
 217   1              PICON = 0x40;
 218   1              
 219   1              set_EPI;
 220   1              
 221   1              set_EA;
 222   1      }
 223          
 224          void main(void)
 225          {
 226   1              unsigned char keystatus,i;
 227   1              Set_All_GPIO_Quasi_Mode;
 228   1              isneedinitsys = 1;
 229   1              isstartsystem = 0;
 230   1              while(1)
 231   1              {
 232   2                      if (isneedinitsys)
 233   2                      {
 234   3                              SysInit();
 235   3                              isneedinitsys = 0;
 236   3                      }
 237   2                      if (is_5ms_Flag)
 238   2                      {
C51 COMPILER V9.54   MAIN                                                                  05/21/2019 21:08:38 PAGE 5   

 239   3                              if (batlevelledtimeout)
 240   3                                      batlevelledtimeout--;
 241   3                              keystatus = KeyScan();          //keystatus->0:null；1：按键；2：安全开关；4：充电；8：长按
 242   3                              if (system_stage == Stage_A)    //没用充电，安全开关没闭合
 243   3                              {
 244   4                                      if (isneedinitstage == 1)
 245   4                                      {
 246   5                                              isneedinitstage = 0;
 247   5                                              //init stage A
 248   5                                              TurnOffMotor();
 249   5                                              LED_Setting(0);
 250   5                                              LED_RGB_Setting(0);
 251   5                                              dpdtime = 0;
 252   5                                              ischarging = 0;
 253   5                                      }
 254   4                                      if (keystatus & 0x01)//key
 255   4                                      {
 256   5                                              //display power as LED
 257   5                                              batlevelledtimeout = 600;
 258   5                                              LED_Setting(system_stage);
 259   5                                      }
 260   4                                      if (keystatus & 0x02)
 261   4                                      {
 262   5                                              system_stage = Stage_B;
 263   5                                              isneedinitstage = 1;
 264   5                                      }
 265   4                                      if (keystatus & 0x04)
 266   4                                      {
 267   5                                              system_stage = Stage_C;
 268   5                                              isneedinitstage = 1;
 269   5                                      }                       
 270   4                              }
 271   3                              else if (system_stage == Stage_B)       //闭合安全开关
 272   3                              {
 273   4                                      if (isneedinitstage == 1)
 274   4                                      {
 275   5                                              isneedinitstage = 0;
 276   5                                              //init stage B
 277   5                                              dpdtime = 0;
 278   5                                              ischarging = 0;
 279   5                                              //check motor level
 280   5                                              i = get_motor_level();                                  
 281   5                                              LED_RGB_Setting(i);
 282   5                                              if (i == 0)
 283   5                                                      LED_Setting(0);
 284   5                                              else
 285   5                                                      LED_Setting(system_stage);
 286   5                                      }
 287   4                                      if (keystatus & 0x01)//key
 288   4                                      {
 289   5                                              //change pwm
 290   5                                              i  = Change_Motor_PWM();
 291   5                                              LED_RGB_Setting(i);
 292   5                                              if (i == 0)
 293   5                                                      LED_Setting(0);
 294   5                                              else
 295   5                                                      LED_Setting(system_stage);
 296   5                                      }
 297   4                                      if (keystatus & 0x02)//safety
 298   4                                      {
 299   5                                      }
 300   4                                      else
C51 COMPILER V9.54   MAIN                                                                  05/21/2019 21:08:38 PAGE 6   

 301   4                                      {
 302   5                                              system_stage = Stage_A;
 303   5                                              isneedinitstage = 1;
 304   5                                              //turn off pwm
 305   5                                              TurnOffMotor();
 306   5                                              LED_RGB_Setting(0);
 307   5                                              LED_Setting(0);
 308   5                                      }
 309   4                                      
 310   4                                      if (keystatus & 0x04)//charging
 311   4                                      {
 312   5                                              system_stage = Stage_D;
 313   5                                              isneedinitstage = 1;
 314   5                                      }
 315   4                                      
 316   4                                      if (keystatus & 0x08)
 317   4                                      {
 318   5                                              //turn off pwm
 319   5                                              TurnOffMotor();
 320   5                                              LED_RGB_Setting(0);
 321   5                                              LED_Setting(0);
 322   5                                      }
 323   4                              }
 324   3                              else if (system_stage == Stage_C)       //充电中
 325   3                              {
 326   4                                      if (isneedinitstage == 1)
 327   4                                      {
 328   5                                              isneedinitstage = 0;
 329   5                                              //init stage C  
 330   5                                              dpdtime = 0;
 331   5                                              ischarging = 1;                                 
 332   5                                              TurnOffMotor();
 333   5                                              LED_RGB_Setting(0);
 334   5                                              LED_Setting(system_stage);
 335   5                                      }
 336   4                                      if (keystatus & 0x01)//key
 337   4                                      {
 338   5                                              
 339   5                                      }
 340   4                                      if (keystatus & 0x02)//safety
 341   4                                      {
 342   5                                              //enter stage_B
 343   5                                              system_stage = Stage_D;
 344   5                                              isneedinitstage = 1;
 345   5                                      }
 346   4                                      
 347   4                                      if (keystatus & 0x04)//charging
 348   4                                      {
 349   5                                              dpdtime = 0;
 350   5                                      }
 351   4                                      else
 352   4                                      {
 353   5                                              system_stage = Stage_A;
 354   5                                              ischarging = 0;
 355   5                                              LED_Setting(0);
 356   5                                              isneedinitstage = 1;
 357   5                                      }
 358   4                              }
 359   3                              else if (system_stage == Stage_D)       //充电和闭合安全开关
 360   3                              {
 361   4                                      if (isneedinitstage == 1)
 362   4                                      {
C51 COMPILER V9.54   MAIN                                                                  05/21/2019 21:08:38 PAGE 7   

 363   5                                              isneedinitstage = 0;
 364   5                                              //init stage D
 365   5                                              dpdtime = 0;
 366   5                                              ischarging = 1;
 367   5                                              //check motor level
 368   5                                              i = get_motor_level();                                  
 369   5                                              LED_RGB_Setting(i);
 370   5                                              LED_Setting(system_stage);
 371   5                                      }
 372   4                                      if (keystatus & 0x01)//key
 373   4                                      {
 374   5                                              //change pwm
 375   5                                              i  = Change_Motor_PWM();
 376   5                                              LED_RGB_Setting(i);
 377   5                                      }
 378   4                                      if (keystatus & 0x02)//safety
 379   4                                      {
 380   5                                      }
 381   4                                      else
 382   4                                      {
 383   5                                              system_stage = Stage_C;
 384   5                                              isneedinitstage = 1;
 385   5                                              TurnOffMotor();
 386   5                                              LED_RGB_Setting(0);
 387   5                                      }
 388   4                                      
 389   4                                      if (keystatus & 0x04)//charging
 390   4                                      {
 391   5                                              dpdtime = 0;
 392   5                                      }
 393   4                                      else
 394   4                                      {
 395   5                                              system_stage = Stage_B;
 396   5                                              ischarging = 0;
 397   5                                              i = get_motor_level();
 398   5                                              LED_RGB_Setting(i);
 399   5                                              if (i == 0)
 400   5                                                      LED_Setting(0);
 401   5                                              else
 402   5                                                      LED_Setting(system_stage);                              
 403   5                                              isneedinitstage = 1;
 404   5                                      }
 405   4                                      
 406   4                                      if (keystatus & 0x08)
 407   4                                      {
 408   5                                              //turn off pwm
 409   5                                              TurnOffMotor();
 410   5                                              LED_RGB_Setting(0);
 411   5                                              LED_Setting(system_stage);
 412   5                                      }
 413   4                              }
 414   3                              
 415   3                              //ADC process
 416   3                              getbatlevel(5);
 417   3                              //pwm rate
 418   3                              if (check_motor_done())
 419   3                              {
 420   4                                      //turn off pwm
 421   4                                      TurnOffMotor();
 422   4                                      LED_RGB_Setting(0);
 423   4                                      LED_Setting(0);
 424   4                                      isneedinitstage = 1;
C51 COMPILER V9.54   MAIN                                                                  05/21/2019 21:08:38 PAGE 8   

 425   4                              }
 426   3                              if(get_motor_level())
 427   3                              {
 428   4                                      dpdtime = 0;
 429   4                              }
 430   3                              //LED_Process           
 431   3                              LED_Process(system_stage);
 432   3                              
 433   3                              //dpd
 434   3                              if (dpdtime >= 2000)
 435   3                              {
 436   4                                      dpdtime = 0;
 437   4                                      //enter dpd
 438   4                                      //
 439   4                                      Set_All_GPIO_Quasi_Mode;
 440   4                                      clr_ADCEN;
 441   4                                      
 442   4                                      TurnOffMotor();
 443   4                                      LED_WHITE_Setting(0);
 444   4                                      LED_RGB_Setting(0);
 445   4                                      DeInit_LED();
 446   4                                      
 447   4                                      P05_wakeup_init();
 448   4                                      
 449   4                                      P17_Input_Mode;
 450   4                                      set_P1S_7;
 451   4                                      set_EX1;
 452   4                                                                      
 453   4                                      set_PD;
 454   4      
 455   4                                      PICON  = 0;
 456   4                                                              
 457   4                                      clr_EX0;
 458   4                                      clr_EX1;
 459   4                                      clr_EPI;
 460   4                                      isneedinitsys = 1;
 461   4                              }
 462   3                      }
 463   2              }
 464   1      }
 465          
 466          void EXT_INT1(void) interrupt 2
 467          {
 468   1              
 469   1      }
 470          
 471          void PinInterrupt_ISR (void) interrupt 7
 472          {
 473   1              if(PIF == 0x10) //pin 0
 474   1                      MOTOR_FG_PinInterrupt_ISR();
 475   1              PIF = 0x00;
 476   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1146    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     29       4
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      5    ----
C51 COMPILER V9.54   MAIN                                                                  05/21/2019 21:08:38 PAGE 9   

END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
