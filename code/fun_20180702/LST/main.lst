C51 COMPILER V9.54   MAIN                                                                  05/22/2019 21:15:38 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Output\main.obj
COMPILER INVOKED BY: D:\keil\C51\BIN\C51.EXE Code\main.c ROM(COMPACT) OPTIMIZE(8,SIZE) BROWSE INCDIR(..\..\Include;..\In
                    -clude) DEFINE(FOSC_160000) DEBUG OBJECTEXTEND PRINT(.\LST\main.lst) OBJECT(.\Output\main.obj)

line level    source

   1          
   2          #include "N76E003.h"
   3          #include "SFR_Macro.h"
   4          #include "Function_define.h"
   5          #include "dataflash.h"
   6          #include "key.h"
   7          #include "motor.h"
   8          #include "led.h"
   9          
  10          #define TH0_INIT        (65536-6667)/256 //5.0ms@XTAL=12MHz, Period = (10.85/2) ms@XTAL=22.1184MHz
  11          #define TL0_INIT        (65536-6667)%256
  12          #define TH1_INIT        0xE0 //2.5ms@XTAL=12MHz, Period = (5.425/2) ms@XTAL=22.1184MHz
  13          #define TL1_INIT        0x00
  14          
  15          bit BIT_TMP;
  16          
  17          unsigned char is_5ms_Flag;
  18          unsigned int dpdtime;
  19          #define ADC_CNT 8
  20          unsigned char adccnt;
  21          unsigned int adc[ADC_CNT];
  22          unsigned char batlevel;
  23          unsigned int batlevelledtimeout;
  24          unsigned int adcvalue;
  25          extern unsigned char Motor_Level;
  26          extern unsigned int led_display_time;
  27          /********************************/
  28          #define Stage_A         1
  29          #define Stage_B         2
  30          #define Stage_C         4
  31          #define Stage_D         8
  32          
  33          unsigned char system_stage;
  34          bit isneedinitstage;
  35          bit isneedinitsys;
  36          bit ischarging;
  37          bit isstartsystem;
  38          unsigned char startADC_cnt;
  39          unsigned char batlevel_led_value;
  40          unsigned char adc_pre_cnt;
  41          /*******************************/
  42          
  43          
  44          /*********************************************************************************************************
             -***
  45          *    TIMER 0 interrupt subroutine
  46          **********************************************************************************************************
             -**/
  47          void Timer0_ISR (void) interrupt 1          //interrupt address is 0x000B
  48          {
  49   1          TH0 = TH0_INIT;
  50   1          TL0 = TL0_INIT;
  51   1              is_5ms_Flag = 1;
  52   1              dpdtime++;
C51 COMPILER V9.54   MAIN                                                                  05/22/2019 21:15:38 PAGE 2   

  53   1              startADC_cnt ++;
  54   1              led_display_time++;
  55   1      }
  56          
  57          void Timer0_Init(void)
  58          {
  59   1              TMOD = 0XFF;
  60   1              TIMER0_MODE1_ENABLE;                        //Timer 0  mode configuration
  61   1          
  62   1              clr_T0M;
  63   1          
  64   1              TH0 = TH0_INIT;
  65   1              TL0 = TL0_INIT;
  66   1          
  67   1              set_ET0;                                    //enable Timer0 interrupt
  68   1              set_EA;                                     //enable interrupts
  69   1              
  70   1              set_TR0;                                    //Timer0 run
  71   1      }
  72          
  73          unsigned int getadcvalue(void)
  74          {
  75   1              unsigned char i;
  76   1              unsigned int adcvalue;
  77   1              adcvalue = 0;
  78   1              for(i=0;i<ADC_CNT;i++)
  79   1              {
  80   2                      adcvalue += adc[i];
  81   2              }
  82   1              adcvalue >>=3;
  83   1              return adcvalue;
  84   1      }
  85          
  86          
  87          unsigned char getbatlevel(unsigned char adc_delay)
  88          {
  89   1              unsigned char templevel;
  90   1              unsigned char i;
  91   1              unsigned char cur_pwm_level;
  92   1              if (startADC_cnt > adc_delay)
  93   1              {
  94   2                      startADC_cnt = 0;
  95   2                      clr_ADCF;
  96   2                      set_ADCS;                                                                       // ADC start trig signal
  97   2                      while(ADCF == 0);
  98   2                      adcvalue = ADCRH;
  99   2                      adcvalue <<= 4;
 100   2                      adcvalue |= ADCRL&0x0F;
 101   2                      adc[adccnt] = adcvalue;
 102   2                      adccnt++;
 103   2                      if (adccnt >= ADC_CNT)
 104   2                      {
 105   3                              adccnt = 0;
 106   3                              adcvalue = getadcvalue();
 107   3                              i = get_motor_level();
 108   3                              if (i == 1)
 109   3                              {
 110   4                                      cur_pwm_level = cur_pwm();
 111   4                                      if (cur_pwm_level == 1)
 112   4                                              adcvalue = adcvalue + 0x08;
 113   4                                      else if (cur_pwm_level == 2)
 114   4                                              adcvalue = adcvalue + 0x10;
C51 COMPILER V9.54   MAIN                                                                  05/22/2019 21:15:38 PAGE 3   

 115   4                                      else
 116   4                                              adcvalue = adcvalue + 0x20;
 117   4                              }
 118   3                              else if (i == 2)
 119   3                              {
 120   4                                      adcvalue = adcvalue + 0x10;
 121   4                              }
 122   3                              else if (i == 4)
 123   3                              {
 124   4                                      adcvalue = adcvalue + 0x08;
 125   4                              }
 126   3                              if (ischarging)
 127   3                              {
 128   4                                      if (batlevel < 3)
 129   4                                              adcvalue = adcvalue - 0x50;
 130   4                                      else if (batlevel < 5)
 131   4                                              adcvalue = adcvalue - 0x40;
 132   4                                      else
 133   4                                              adcvalue = adcvalue - 0x30;     //0x90 -> 0.3v
 134   4                              }
 135   3                              if (adcvalue > 0xD20)           //100% 8.2
 136   3                              {
 137   4                                      templevel = 6;
 138   4                              }
 139   3                              else if (adcvalue > 0xCB0)      //>75%  8v              
 140   3                              {
 141   4                                      templevel = 5;
 142   4                              }
 143   3                              else if (adcvalue > 0xC40)      //>50%  7.7v
 144   3                              {
 145   4                                      templevel = 4;
 146   4                              }
 147   3                              else if (adcvalue > 0xBE0)      //>25%  7.5
 148   3                              {
 149   4                                      templevel = 3;
 150   4                              }
 151   3                              else if (adcvalue > 0xBA0)      //10%   7.2v
 152   3                              {
 153   4                                      templevel = 2;
 154   4                              }
 155   3                              else
 156   3                              {
 157   4                                      templevel = 1;
 158   4                              }
 159   3                              if (batlevel != templevel)
 160   3                                      adc_pre_cnt++;
 161   3                              else
 162   3                                      adc_pre_cnt = 0;
 163   3                              if (adc_pre_cnt > 4)
 164   3                              {
 165   4                                      adc_pre_cnt = 0;
 166   4                                      batlevel = templevel;
 167   4                              }
 168   3                              return 1;
 169   3                      }
 170   2              }       
 171   1              return 0;
 172   1      }
 173          
 174          
 175          void SysInit(void)
 176          {
C51 COMPILER V9.54   MAIN                                                                  05/22/2019 21:15:38 PAGE 4   

 177   1              Init_LED();
 178   1              Timer0_Init();  
 179   1              startADC_cnt = 0;
 180   1              adccnt = 0;
 181   1              KeyInit();      
 182   1              InitPWM();
 183   1              system_stage = Stage_A;
 184   1              isneedinitstage = 1;
 185   1              batlevelledtimeout = 0; 
 186   1              batlevel_led_value = 0;
 187   1              ischarging = 0;
 188   1              adc_pre_cnt = 0;
 189   1              Enable_ADC_AIN2;
 190   1              if (isstartsystem == 0)
 191   1              {
 192   2                      while(dpdtime<60)
 193   2                      {
 194   3                              getbatlevel(0);
 195   3                      }
 196   2                      isstartsystem = 1;
 197   2              }
 198   1              else
 199   1              {
 200   2                      while(dpdtime<20)
 201   2                      {
 202   3                              getbatlevel(1);
 203   3                      }               
 204   2              }
 205   1              dpdtime = 0;
 206   1              led_display_time = 0;
 207   1              startADC_cnt = 0;
 208   1      }
 209          
 210          void P05_wakeup_init(void){
 211   1              P05_Input_Mode;
 212   1              
 213   1              PINEN = 0x20;
 214   1              PIPEN = 0x00;
 215   1              PICON = 0x40;
 216   1              
 217   1              set_EPI;
 218   1              
 219   1              set_EA;
 220   1      }
 221          
 222          void main(void)
 223          {
 224   1              unsigned char keystatus,i;
 225   1              Set_All_GPIO_Quasi_Mode;
 226   1              isneedinitsys = 1;
 227   1              isstartsystem = 0;
 228   1              while(1)
 229   1              {
 230   2                      if (isneedinitsys)
 231   2                      {
 232   3                              SysInit();
 233   3                              isneedinitsys = 0;
 234   3                      }
 235   2                      if (is_5ms_Flag)
 236   2                      {
 237   3                              if (batlevelledtimeout)
 238   3                                      batlevelledtimeout--;
C51 COMPILER V9.54   MAIN                                                                  05/22/2019 21:15:38 PAGE 5   

 239   3                              keystatus = KeyScan();          //keystatus->0:null；1：按键；2：安全开关；4：充电；8：长按
 240   3                              if (system_stage == Stage_A)    //没用充电，安全开关没闭合
 241   3                              {
 242   4                                      if (isneedinitstage == 1)
 243   4                                      {
 244   5                                              isneedinitstage = 0;
 245   5                                              //init stage A
 246   5                                              TurnOffMotor();
 247   5                                              LED_Setting(0);
 248   5                                              LED_RGB_Setting(0);
 249   5                                              dpdtime = 0;
 250   5                                              ischarging = 0;
 251   5                                      }
 252   4                                      if (keystatus & 0x01)//key
 253   4                                      {
 254   5                                              //display power as LED
 255   5                                              batlevelledtimeout = 600;
 256   5                                              LED_Setting(system_stage);
 257   5                                      }
 258   4                                      if (keystatus & 0x02)
 259   4                                      {
 260   5                                              system_stage = Stage_B;
 261   5                                              isneedinitstage = 1;
 262   5                                      }
 263   4                                      if (keystatus & 0x04)
 264   4                                      {
 265   5                                              system_stage = Stage_C;
 266   5                                              isneedinitstage = 1;
 267   5                                      }                       
 268   4                              }
 269   3                              else if (system_stage == Stage_B)       //闭合安全开关
 270   3                              {
 271   4                                      if (isneedinitstage == 1)
 272   4                                      {
 273   5                                              isneedinitstage = 0;
 274   5                                              //init stage B
 275   5                                              dpdtime = 0;
 276   5                                              ischarging = 0;
 277   5                                              //check motor level
 278   5                                              i = get_motor_level();                                  
 279   5                                              LED_RGB_Setting(i);
 280   5                                              if (i == 0)
 281   5                                                      LED_Setting(0);
 282   5                                              else
 283   5                                                      LED_Setting(system_stage);
 284   5                                      }
 285   4                                      if (keystatus & 0x01)//key
 286   4                                      {
 287   5                                              //change pwm
 288   5                                              i  = Change_Motor_PWM();
 289   5                                              LED_RGB_Setting(i);
 290   5                                              if (i == 0)
 291   5                                                      LED_Setting(0);
 292   5                                              else
 293   5                                                      LED_Setting(system_stage);
 294   5                                      }
 295   4                                      if (keystatus & 0x02)//safety
 296   4                                      {
 297   5                                      }
 298   4                                      else
 299   4                                      {
 300   5                                              system_stage = Stage_A;
C51 COMPILER V9.54   MAIN                                                                  05/22/2019 21:15:38 PAGE 6   

 301   5                                              isneedinitstage = 1;
 302   5                                              //turn off pwm
 303   5                                              TurnOffMotor();
 304   5                                              LED_RGB_Setting(0);
 305   5                                              LED_Setting(0);
 306   5                                      }
 307   4                                      
 308   4                                      if (keystatus & 0x04)//charging
 309   4                                      {
 310   5                                              system_stage = Stage_D;
 311   5                                              isneedinitstage = 1;
 312   5                                      }
 313   4                                      
 314   4                                      if (keystatus & 0x08)
 315   4                                      {
 316   5                                              //turn off pwm
 317   5                                              TurnOffMotor();
 318   5                                              LED_RGB_Setting(0);
 319   5                                              LED_Setting(0);
 320   5                                      }
 321   4                              }
 322   3                              else if (system_stage == Stage_C)       //充电中
 323   3                              {
 324   4                                      if (isneedinitstage == 1)
 325   4                                      {
 326   5                                              isneedinitstage = 0;
 327   5                                              //init stage C  
 328   5                                              dpdtime = 0;
 329   5                                              ischarging = 1;                                 
 330   5                                              TurnOffMotor();
 331   5                                              LED_RGB_Setting(0);
 332   5                                              LED_Setting(system_stage);
 333   5                                      }
 334   4                                      if (keystatus & 0x01)//key
 335   4                                      {
 336   5                                              
 337   5                                      }
 338   4                                      if (keystatus & 0x02)//safety
 339   4                                      {
 340   5                                              //enter stage_B
 341   5                                              system_stage = Stage_D;
 342   5                                              isneedinitstage = 1;
 343   5                                      }
 344   4                                      
 345   4                                      if (keystatus & 0x04)//charging
 346   4                                      {
 347   5                                              dpdtime = 0;
 348   5                                      }
 349   4                                      else
 350   4                                      {
 351   5                                              system_stage = Stage_A;
 352   5                                              ischarging = 0;
 353   5                                              LED_Setting(0);
 354   5                                              isneedinitstage = 1;
 355   5                                      }
 356   4                              }
 357   3                              else if (system_stage == Stage_D)       //充电和闭合安全开关
 358   3                              {
 359   4                                      if (isneedinitstage == 1)
 360   4                                      {
 361   5                                              isneedinitstage = 0;
 362   5                                              //init stage D
C51 COMPILER V9.54   MAIN                                                                  05/22/2019 21:15:38 PAGE 7   

 363   5                                              dpdtime = 0;
 364   5                                              ischarging = 1;
 365   5                                              //check motor level
 366   5                                              i = get_motor_level();                                  
 367   5                                              LED_RGB_Setting(i);
 368   5                                              LED_Setting(system_stage);
 369   5                                      }
 370   4                                      if (keystatus & 0x01)//key
 371   4                                      {
 372   5                                              //change pwm
 373   5                                              i  = Change_Motor_PWM();
 374   5                                              LED_RGB_Setting(i);
 375   5                                      }
 376   4                                      if (keystatus & 0x02)//safety
 377   4                                      {
 378   5                                      }
 379   4                                      else
 380   4                                      {
 381   5                                              system_stage = Stage_C;
 382   5                                              isneedinitstage = 1;
 383   5                                              TurnOffMotor();
 384   5                                              LED_RGB_Setting(0);
 385   5                                      }
 386   4                                      
 387   4                                      if (keystatus & 0x04)//charging
 388   4                                      {
 389   5                                              dpdtime = 0;
 390   5                                      }
 391   4                                      else
 392   4                                      {
 393   5                                              system_stage = Stage_B;
 394   5                                              ischarging = 0;
 395   5                                              i = get_motor_level();
 396   5                                              LED_RGB_Setting(i);
 397   5                                              if (i == 0)
 398   5                                                      LED_Setting(0);
 399   5                                              else
 400   5                                                      LED_Setting(system_stage);                              
 401   5                                              isneedinitstage = 1;
 402   5                                      }
 403   4                                      
 404   4                                      if (keystatus & 0x08)
 405   4                                      {
 406   5                                              //turn off pwm
 407   5                                              TurnOffMotor();
 408   5                                              LED_RGB_Setting(0);
 409   5                                              LED_Setting(system_stage);
 410   5                                      }
 411   4                              }
 412   3                              
 413   3                              //ADC process
 414   3                              getbatlevel(5);
 415   3                              //pwm rate
 416   3                              if (check_motor_done())
 417   3                              {
 418   4                                      //turn off pwm
 419   4                                      TurnOffMotor();
 420   4                                      LED_RGB_Setting(0);
 421   4                                      LED_Setting(0);
 422   4                                      isneedinitstage = 1;
 423   4                              }
 424   3                              if(get_motor_level())
C51 COMPILER V9.54   MAIN                                                                  05/22/2019 21:15:38 PAGE 8   

 425   3                              {
 426   4                                      dpdtime = 0;
 427   4                              }
 428   3                              //LED_Process           
 429   3                              LED_Process(system_stage);
 430   3                              
 431   3                              //dpd
 432   3                              if (dpdtime >= 2000)
 433   3                              {
 434   4                                      dpdtime = 0;
 435   4                                      //enter dpd
 436   4                                      //
 437   4                                      Set_All_GPIO_Quasi_Mode;
 438   4                                      clr_ADCEN;
 439   4                                      
 440   4                                      TurnOffMotor();
 441   4                                      LED_WHITE_Setting(0);
 442   4                                      LED_RGB_Setting(0);
 443   4                                      DeInit_LED();
 444   4                                      
 445   4                                      P05_wakeup_init();
 446   4                                      
 447   4                                      P17_Input_Mode;
 448   4                                      set_P1S_7;
 449   4                                      set_EX1;
 450   4                                                                      
 451   4                                      set_PD;
 452   4      
 453   4                                      PICON  = 0;
 454   4                                                              
 455   4                                      clr_EX0;
 456   4                                      clr_EX1;
 457   4                                      clr_EPI;
 458   4                                      isneedinitsys = 1;
 459   4                              }
 460   3                      }
 461   2              }
 462   1      }
 463          
 464          void EXT_INT1(void) interrupt 2
 465          {
 466   1              
 467   1      }
 468          
 469          void PinInterrupt_ISR (void) interrupt 7
 470          {
 471   1              if(PIF == 0x10) //pin 0
 472   1                      MOTOR_FG_PinInterrupt_ISR();
 473   1              PIF = 0x00;
 474   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1141    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     29       4
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      5    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
