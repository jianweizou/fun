C51 COMPILER V9.54   MAIN                                                                  04/22/2019 21:34:19 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Output\main.obj
COMPILER INVOKED BY: D:\keil\C51\BIN\C51.EXE Code\main.c ROM(COMPACT) OPTIMIZE(8,SIZE) BROWSE INCDIR(..\..\Include;..\In
                    -clude) DEFINE(FOSC_160000) DEBUG OBJECTEXTEND PRINT(.\LST\main.lst) OBJECT(.\Output\main.obj)

line level    source

   1          
   2          #include "N76E003.h"
   3          #include "SFR_Macro.h"
   4          #include "Function_define.h"
   5          #include "dataflash.h"
   6          #include "key.h"
   7          #include "motor.h"
   8          #include "led.h"
   9          
  10          #define TH0_INIT        (65536-6667)/256 //5.0ms@XTAL=12MHz, Period = (10.85/2) ms@XTAL=22.1184MHz
  11          #define TL0_INIT        (65536-6667)%256
  12          #define TH1_INIT        0xE0 //2.5ms@XTAL=12MHz, Period = (5.425/2) ms@XTAL=22.1184MHz
  13          #define TL1_INIT        0x00
  14          
  15          bit BIT_TMP;
  16          
  17          unsigned char is_5ms_Flag;
  18          unsigned int dpdtime;
  19          #define ADC_CNT 8
  20          unsigned char adccnt;
  21          unsigned int adc[ADC_CNT];
  22          unsigned char batlevel;
  23          unsigned int batlevelledtimeout;
  24          unsigned int adcvalue;
  25          extern unsigned char Motor_Level;
  26          extern unsigned int led_display_time;
  27          /********************************/
  28          #define Stage_A         1
  29          #define Stage_B         2
  30          #define Stage_C         4
  31          #define Stage_D         8
  32          
  33          unsigned char system_stage;
  34          bit isneedinitstage;
  35          bit isneedinitbatled;
  36          bit isneedinitsys;
  37          bit ischarging;
  38          bit isstartsystem;
  39          unsigned char startADC_cnt;
  40          unsigned char batlevel_led_value;
  41          unsigned char led_type;
  42          unsigned char adc_pre_cnt;
  43          /*******************************/
  44          
  45          
  46          /*********************************************************************************************************
             -***
  47          *    TIMER 0 interrupt subroutine
  48          **********************************************************************************************************
             -**/
  49          void Timer0_ISR (void) interrupt 1          //interrupt address is 0x000B
  50          {
  51   1          TH0 = TH0_INIT;
  52   1          TL0 = TL0_INIT;
C51 COMPILER V9.54   MAIN                                                                  04/22/2019 21:34:19 PAGE 2   

  53   1              is_5ms_Flag = 1;
  54   1              dpdtime++;
  55   1              startADC_cnt ++;
  56   1              led_display_time++;
  57   1              if (isStartMotor)
  58   1                      Motor_done_cnt++;
  59   1      }
  60          
  61          void Timer0_Init(void)
  62          {
  63   1              TMOD = 0XFF;
  64   1              TIMER0_MODE1_ENABLE;                        //Timer 0  mode configuration
  65   1          
  66   1              clr_T0M;
  67   1          
  68   1              TH0 = TH0_INIT;
  69   1              TL0 = TL0_INIT;
  70   1          
  71   1              set_ET0;                                    //enable Timer0 interrupt
  72   1              set_EA;                                     //enable interrupts
  73   1              
  74   1              set_TR0;                                    //Timer0 run
  75   1      }
  76          
  77          unsigned int getadcvalue(void)
  78          {
  79   1              unsigned char i;
  80   1              unsigned int adcvalue;
  81   1              adcvalue = 0;
  82   1              for(i=0;i<ADC_CNT;i++)
  83   1              {
  84   2                      adcvalue += adc[i];
  85   2              }
  86   1              adcvalue >>=3;
  87   1              return adcvalue;
  88   1      }
  89          
  90          
  91          unsigned char getbatlevel(void)
  92          {
  93   1              unsigned char templevel;
  94   1              unsigned char i;
  95   1              unsigned char cur_pwm_level;
  96   1              if (startADC_cnt > 0)
  97   1              {
  98   2                      startADC_cnt = 0;
  99   2                      clr_ADCF;
 100   2                      set_ADCS;                                                                       // ADC start trig signal
 101   2                      while(ADCF == 0);
 102   2                      adcvalue = ADCRH;
 103   2                      adcvalue <<= 4;
 104   2                      adcvalue |= ADCRL&0x0F;
 105   2                      adc[adccnt] = adcvalue;
 106   2                      adccnt++;
 107   2                      if (adccnt >= ADC_CNT)
 108   2                      {
 109   3                              adccnt = 0;
 110   3                              adcvalue = getadcvalue();
 111   3                              i = get_motor_level();
 112   3                              if (i == 1)
 113   3                              {
 114   4                                      cur_pwm_level = cur_pwm();
C51 COMPILER V9.54   MAIN                                                                  04/22/2019 21:34:19 PAGE 3   

 115   4      //                              if (cur_pwm_level == 0)
 116   4      //                                      adcvalue = adcvalue + 0x30;
 117   4      //                              else
 118   4                                      if (cur_pwm_level == 1)
 119   4                                              adcvalue = adcvalue + 0x08;
 120   4                                      else if (cur_pwm_level == 2)
 121   4                                              adcvalue = adcvalue + 0x10;
 122   4                                      else
 123   4                                              adcvalue = adcvalue + 0x20;
 124   4                              }
 125   3                              else if (i == 2)
 126   3                              {
 127   4                                      adcvalue = adcvalue + 0x10;
 128   4                              }
 129   3                              else if (i == 4)
 130   3                              {
 131   4                                      adcvalue = adcvalue + 0x08;
 132   4                              }
 133   3                              if (ischarging)
 134   3                              {
 135   4                                      if (batlevel < 3)
 136   4                                              adcvalue = adcvalue - 0x50;
 137   4                                      else if (batlevel < 5)
 138   4                                              adcvalue = adcvalue - 0x40;
 139   4                                      else
 140   4                                              adcvalue = adcvalue - 0x30;     //0x90 -> 0.3v
 141   4                              }
 142   3                              if (adcvalue > 0xD20)           //100% 8.2
 143   3                              {
 144   4                                      templevel = 6;
 145   4                              }
 146   3                              else if (adcvalue > 0xCB0)      //>75%  8v              
 147   3                              {
 148   4                                      templevel = 5;
 149   4                              }
 150   3                              else if (adcvalue > 0xC40)      //>50%  7.7v
 151   3                              {
 152   4                                      templevel = 4;
 153   4                              }
 154   3                              else if (adcvalue > 0xBE0)      //>25%  7.5
 155   3                              {
 156   4                                      templevel = 3;
 157   4                              }
 158   3                              else if (adcvalue > 0xBA0)      //10%   7.2v
 159   3                              {
 160   4                                      templevel = 2;
 161   4                              }
 162   3                              else
 163   3                              {
 164   4                                      templevel = 1;
 165   4                              }
 166   3      //                      else if (adcvalue < 0xA00)
 167   3      //                      {
 168   3      //                              templevel = 0;
 169   3      //                      }
 170   3                              if (batlevel != templevel)
 171   3                                      adc_pre_cnt++;
 172   3                              else
 173   3                                      adc_pre_cnt = 0;
 174   3                              if (adc_pre_cnt > 4)
 175   3                              {
 176   4                                      adc_pre_cnt = 0;
C51 COMPILER V9.54   MAIN                                                                  04/22/2019 21:34:19 PAGE 4   

 177   4                                      batlevel = templevel;
 178   4                              }
 179   3      //                      batlevel_led_value = batlevel_to_led_value();
 180   3                              return 1;
 181   3                      }
 182   2              }       
 183   1              return 0;
 184   1      }
 185          
 186          
 187          void SysInit(void)
 188          {
 189   1              Init_LED();
 190   1              Timer0_Init();  
 191   1              startADC_cnt = 0;
 192   1              adccnt = 0;
 193   1              KeyInit();      
 194   1              InitPWM();
 195   1              system_stage = Stage_A;
 196   1              isneedinitstage = 1;
 197   1              led_type = 0; 
 198   1              isneedinitbatled = 0;
 199   1              batlevelledtimeout = 0; 
 200   1              batlevel_led_value = 0;
 201   1              ischarging = 0;
 202   1              adc_pre_cnt = 0;
 203   1      //      P07_PushPull_Mode;
 204   1      //      P07 = 1;
 205   1      //      P07_Input_Mode;
 206   1              Enable_ADC_AIN2;
 207   1              if (isstartsystem == 0)
 208   1              {
 209   2                      while(dpdtime<60)
 210   2                      {
 211   3                              getbatlevel();
 212   3      //                      startADC_cnt++;
 213   3                      }
 214   2                      isstartsystem = 1;
 215   2              }
 216   1              else
 217   1              {
 218   2                      while(dpdtime<10)
 219   2                      {
 220   3                              getbatlevel();
 221   3                      }               
 222   2              }
 223   1              dpdtime = 0;
 224   1              led_display_time = 0;
 225   1              startADC_cnt = 0;
 226   1      //      while(1)
 227   1      //      {
 228   1      //              if (getbatlevel() == 1)
 229   1      //                      break;
 230   1      //      }
 231   1      }
 232          
 233          void main(void)
 234          {
 235   1              unsigned char keystatus,i;
 236   1              Set_All_GPIO_Quasi_Mode;
 237   1              isneedinitsys = 1;
 238   1              isstartsystem = 0;
C51 COMPILER V9.54   MAIN                                                                  04/22/2019 21:34:19 PAGE 5   

 239   1              while(1)
 240   1              {
 241   2                      if (isneedinitsys)
 242   2                      {
 243   3                              SysInit();
 244   3                              isneedinitsys = 0;
 245   3                      }
 246   2                      if (is_5ms_Flag)
 247   2                      {
 248   3                              if (batlevelledtimeout)
 249   3                                      batlevelledtimeout--;
 250   3                              keystatus = KeyScan();
 251   3                              if (system_stage == Stage_A)
 252   3                              {
 253   4                                      if (isneedinitstage == 1)
 254   4                                      {
 255   5                                              isneedinitstage = 0;
 256   5                                              //init stage A
 257   5                                              LED_Setting(0,0);
 258   5                                              LED_RGB_Setting(0,0);
 259   5                                              led_type = 0;
 260   5                                              dpdtime = 0;
 261   5                                              ischarging = 0;
 262   5                                      }
 263   4                                      if (keystatus & 0x01)//key
 264   4                                      {
 265   5                                              //display power as LED
 266   5                                              led_type = 1;
 267   5                                              isneedinitbatled = 1;
 268   5                                              batlevelledtimeout = 600;
 269   5                                              LED_Setting(system_stage,batlevel);
 270   5                                      }
 271   4                                      if (keystatus & 0x02)
 272   4                                      {
 273   5                                              system_stage = Stage_B;
 274   5                                              isneedinitstage = 1;
 275   5                                      }
 276   4                                      if (keystatus & 0x04)
 277   4                                      {
 278   5                                              if (system_stage == Stage_B)
 279   5                                                      system_stage = Stage_D;
 280   5                                              else
 281   5                                                      system_stage = Stage_C;
 282   5                                              isneedinitstage = 1;
 283   5                                      }                       
 284   4                              }
 285   3                              else if (system_stage == Stage_B)
 286   3                              {
 287   4                                      if (isneedinitstage == 1)
 288   4                                      {
 289   5                                              isneedinitstage = 0;
 290   5                                              //init stage B
 291   5                                              led_type = 2;   
 292   5                                              isneedinitbatled = 1;
 293   5                                              dpdtime = 0;
 294   5                                              ischarging = 0;                 
 295   5                                      }
 296   4                                      if (keystatus & 0x01)//key
 297   4                                      {
 298   5                                              //change pwm
 299   5                                              i  = Change_Motor_PWM();
 300   5                                              LED_RGB_Setting(i,0);
C51 COMPILER V9.54   MAIN                                                                  04/22/2019 21:34:19 PAGE 6   

 301   5                                              if (i == 0)
 302   5                                                      LED_Setting(0,0);
 303   5                                              else
 304   5                                                      LED_Setting(system_stage,batlevel);
 305   5                                      }
 306   4                                      if (keystatus & 0x02)//safety
 307   4                                      {
 308   5                                      }
 309   4                                      else
 310   4                                      {
 311   5                                              system_stage = Stage_A;
 312   5                                              isneedinitstage = 1;
 313   5                                              //turn off pwm
 314   5                                              TurnOffMotor();
 315   5                                              LED_RGB_Setting(0,0);
 316   5                                              LED_Setting(0,0);
 317   5                                      }
 318   4                                      
 319   4                                      if (keystatus & 0x04)//charging
 320   4                                      {
 321   5                                              if (system_stage == Stage_A)
 322   5                                              {
 323   6                                                      system_stage = Stage_C;
 324   6                                              }
 325   5                                              else
 326   5                                                      system_stage = Stage_D;
 327   5      //                                      TurnOffMotor();
 328   5      //                                      LED_RGB_Setting(0,0);
 329   5                                              isneedinitstage = 1;
 330   5                                      }
 331   4                                      
 332   4                                      if (keystatus & 0x08)
 333   4                                      {
 334   5                                              //turn off pwm
 335   5                                              TurnOffMotor();
 336   5                                              LED_RGB_Setting(0,0);
 337   5                                              LED_Setting(0,0);
 338   5                                      }
 339   4                                      
 340   4                              }
 341   3                              else if (system_stage == Stage_C)
 342   3                              {
 343   4                                      if (isneedinitstage == 1)
 344   4                                      {
 345   5                                              isneedinitstage = 0;
 346   5                                              //init stage C
 347   5                                              led_type = 3;   
 348   5                                              isneedinitbatled = 1;
 349   5                                              dpdtime = 0;
 350   5                                              ischarging = 1;
 351   5                                              LED_Setting(system_stage,batlevel);
 352   5                                              //turn off pwm
 353   5      //                                      TurnOffMotor();
 354   5      //                                      LED_RGB_Setting(0,0);
 355   5                                      }
 356   4                                      if (keystatus & 0x01)//key
 357   4                                      {
 358   5                                              
 359   5                                      }
 360   4                                      if (keystatus & 0x02)//safety
 361   4                                      {
 362   5                                              //enter stage_B
C51 COMPILER V9.54   MAIN                                                                  04/22/2019 21:34:19 PAGE 7   

 363   5                                              system_stage = Stage_D;
 364   5                                              isneedinitstage = 1;
 365   5                                      }
 366   4                                      
 367   4                                      if (keystatus & 0x04)//charging
 368   4                                      {
 369   5                                              dpdtime = 0;
 370   5                                      }
 371   4                                      else
 372   4                                      {
 373   5                                              if (system_stage == Stage_D)
 374   5                                              {
 375   6                                                      system_stage = Stage_B;
 376   6                                              }
 377   5                                              else
 378   5                                              {
 379   6                                                      system_stage = Stage_A;
 380   6                                                      LED_Setting(0,0);
 381   6                                              }
 382   5                                              isneedinitstage = 1;
 383   5                                      }
 384   4                              }
 385   3                              else if (system_stage == Stage_D)
 386   3                              {
 387   4                                      if (isneedinitstage == 1)
 388   4                                      {
 389   5                                              isneedinitstage = 0;
 390   5                                              isneedinitbatled = 1;
 391   5                                              //init stage D
 392   5                                              led_type = 3;
 393   5                                              dpdtime = 0;
 394   5                                              ischarging = 1;
 395   5                                              LED_Setting(system_stage,batlevel);
 396   5                                      }
 397   4                                      if (keystatus & 0x01)//key
 398   4                                      {
 399   5                                              //change pwm
 400   5                                              i  = Change_Motor_PWM();
 401   5                                              LED_RGB_Setting(i,0);
 402   5                                      }
 403   4                                      if (keystatus & 0x02)//safety
 404   4                                      {
 405   5                                      }
 406   4                                      else
 407   4                                      {
 408   5                                              system_stage = Stage_C;
 409   5                                              isneedinitstage = 1;
 410   5                                              TurnOffMotor();
 411   5                                              LED_RGB_Setting(0,0);
 412   5                                      }
 413   4                                      
 414   4                                      if (keystatus & 0x04)//charging
 415   4                                      {
 416   5                                              dpdtime = 0;
 417   5                                      }
 418   4                                      else
 419   4                                      {
 420   5                                              if (system_stage == Stage_C)
 421   5                                              {
 422   6                                                      system_stage = Stage_A;
 423   6                                              }
 424   5                                              else
C51 COMPILER V9.54   MAIN                                                                  04/22/2019 21:34:19 PAGE 8   

 425   5                                              {
 426   6                                                      system_stage = Stage_B;
 427   6                                                      i = get_motor_level();
 428   6                                                      LED_RGB_Setting(i,0);
 429   6                                                      if (i == 0)
 430   6                                                              LED_Setting(0,0);
 431   6                                                      else
 432   6                                                              LED_Setting(system_stage,batlevel);
 433   6                                              }
 434   5                                              isneedinitstage = 1;    
 435   5      //                                      TurnOffMotor(); 
 436   5      //                                      LED_RGB_Setting(0,0);
 437   5                                      }
 438   4                                      
 439   4                                      if (keystatus & 0x08)
 440   4                                      {
 441   5                                              //turn off pwm
 442   5                                              TurnOffMotor();
 443   5                                              LED_RGB_Setting(0,0);
 444   5                                      }
 445   4                              }
 446   3                              
 447   3                              //ADC process
 448   3                              getbatlevel();
 449   3                              /*
 450   3                              if (led_type)
 451   3                              {
 452   3                                      if(isneedinitbatled && batlevel_led_value)
 453   3                                      {
 454   3                                              i = led_type - 1;
 455   3                                              LED_WHITE_Setting(batlevel_led_value,i);
 456   3                                              isneedinitbatled = 0;
 457   3                                      }
 458   3                                      if(batlevelledtimeout==0)
 459   3                                      {
 460   3                                              if (led_type == 1)
 461   3                                              {
 462   3                                                      led_type = 0;
 463   3                                                      LED_WHITE_Setting(0,0);
 464   3                                              }
 465   3                                      }
 466   3                              }
 467   3                              */
 468   3                              //pwm rate
 469   3                              if (check_motor_done())
 470   3                              {
 471   4                                      //turn off pwm
 472   4                                      TurnOffMotor();
 473   4                                      LED_RGB_Setting(0,0);
 474   4                                      LED_Setting(0,0);
 475   4                                      //goto stage A,B
 476   4                                      #warning "change stage to A or B"
*** WARNING C320 IN LINE 476 OF Code\main.c: "change stage to A or B"
 477   4                              }
 478   3                              if(get_motor_level())
 479   3                              {
 480   4                                      dpdtime = 0;
 481   4                              }
 482   3                              //LED_Process           
 483   3                              LED_Process(system_stage,batlevel_led_value);
 484   3                              
 485   3                              //dpd
C51 COMPILER V9.54   MAIN                                                                  04/22/2019 21:34:19 PAGE 9   

 486   3                              if (dpdtime >= 2000)
 487   3                              {
 488   4                                      dpdtime = 0;
 489   4                                      //enter dpd
 490   4                                      //
 491   4                                      Set_All_GPIO_Quasi_Mode;
 492   4                                      clr_ADCEN;
 493   4                                      
 494   4                                      TurnOffMotor();
 495   4                                      LED_WHITE_Setting(0,0);
 496   4                                      LED_RGB_Setting(0,0);
 497   4                                      DeInit_LED();
*** WARNING C206 IN LINE 497 OF Code\main.c: 'DeInit_LED': missing function-prototype
 498   4                                      
 499   4                                      P17_Input_Mode;
 500   4                                      set_P1S_7;
 501   4                                      set_EX1;
 502   4                                                                      
 503   4                                      set_PD;
 504   4      
 505   4                                      PICON  = 0;
 506   4                                                              
 507   4                                      clr_EX0;
 508   4                                      clr_EX1;
 509   4                                      clr_EPI;
 510   4                                      isneedinitsys = 1;
 511   4                              }
 512   3                      }
 513   2              }
 514   1      }
 515          
 516          void EXT_INT1(void) interrupt 2
 517          {
 518   1              
 519   1      }
 520          
 521          void PinInterrupt_ISR (void) interrupt 7
 522          {
 523   1              if(PIF == 0x10) //pin 0
 524   1                      MOTOR_FG_PinInterrupt_ISR();
 525   1              PIF = 0x00;
 526   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1168    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     30       4
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      6    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  2 WARNING(S),  0 ERROR(S)
