C51 COMPILER V9.54   MAIN                                                                  05/31/2019 01:35:39 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Output\main.obj
COMPILER INVOKED BY: D:\keil\C51\BIN\C51.EXE Code\main.c ROM(COMPACT) OPTIMIZE(8,SIZE) BROWSE INCDIR(..\..\Include;..\In
                    -clude) DEFINE(FOSC_160000) DEBUG OBJECTEXTEND PRINT(.\LST\main.lst) OBJECT(.\Output\main.obj)

line level    source

   1          
   2          #include "N76E003.h"
   3          #include "SFR_Macro.h"
   4          #include "Function_define.h"
   5          #include "dataflash.h"
   6          #include "key.h"
   7          #include "motor.h"
   8          #include "led.h"
   9          
  10          #define TH0_INIT        (65536-6667)/256 //5.0ms@XTAL=12MHz, Period = (10.85/2) ms@XTAL=22.1184MHz
  11          #define TL0_INIT        (65536-6667)%256
  12          #define TH1_INIT        0xE0 //2.5ms@XTAL=12MHz, Period = (5.425/2) ms@XTAL=22.1184MHz
  13          #define TL1_INIT        0x00
  14          
  15          bit BIT_TMP;
  16          
  17          unsigned char is_5ms_Flag;
  18          unsigned int dpdtime;
  19          #define ADC_CNT 8
  20          unsigned char adccnt;
  21          unsigned int adc[ADC_CNT];
  22          unsigned char batlevel;
  23          unsigned int batlevelledtimeout;
  24          unsigned int adcvalue;
  25          unsigned char adc_dis_cnt;
  26          unsigned int DPD_CNT=0;
  27          unsigned char adcchangecnt=0;
  28          extern unsigned char Motor_Level;
  29          extern unsigned int led_display_time;
  30          /********************************/
  31          #define Stage_A         1
  32          #define Stage_B         2
  33          #define Stage_C         4
  34          #define Stage_D         8
  35          
  36          unsigned char system_stage;
  37          bit isneedinitstage;
  38          bit isneedinitsys;
  39          bit ischarging;
  40          bit isstartsystem;
  41          bit isWaitTurnOffCharging;
  42          bit isfirstenterdpd;
  43          unsigned char startADC_cnt;
  44          unsigned char batlevel_led_value;
  45          unsigned char adc_pre_cnt;
  46          
  47          
  48          
  49          #define UART_TEST       0
  50          
  51          #if UART_TEST
              #define set_SWRST   BIT_TMP=EA;EA=0;TA=0xAA;TA=0x55;CHPCON|=SET_BIT7 ;EA=BIT_TMP;
              void SW_Reset(void)
              {
C51 COMPILER V9.54   MAIN                                                                  05/31/2019 01:35:39 PAGE 2   

                  TA = 0xAA;
                  TA = 0x55;
                  set_SWRST;
              }
              float bat_val;
              /*******************************/
              typedef unsigned char         UINT8;
              typedef unsigned int          UINT16;
              typedef unsigned long         UINT32;
              
              typedef unsigned char         uint8_t;
              typedef unsigned int          uint16_t;
              typedef unsigned long         uint32_t;
              /*uart1*/
              void InitialUART1_Timer3(UINT32 u32Baudrate) //use timer3 as Baudrate generator
              {
                              P02_Quasi_Mode;         //Setting UART pin as Quasi mode for transmit
                              P16_Quasi_Mode;         //Setting UART pin as Quasi mode for transmit
                      
                        SCON_1 = 0x50;        //UART1 Mode1,REN_1=1,TI_1=1
                  T3CON = 0x08;       //T3PS2=0,T3PS1=0,T3PS0=0(Prescale=1), UART1 in MODE 1
                              clr_BRCK;
                      
              #ifdef FOSC_160000
                              RH3    = HIBYTE(65536 - (1000000/u32Baudrate)-1);               /*16 MHz */
                              RL3    = LOBYTE(65536 - (1000000/u32Baudrate)-1);                       /*16 MHz */
              #endif
              #ifdef FOSC_166000
                              RH3    = HIBYTE(65536 - (1037500/u32Baudrate));                         /*16.6 MHz */
                              RL3    = LOBYTE(65536 - (1037500/u32Baudrate));                         /*16.6 MHz */
              #endif
                  set_TR3;         //Trigger Timer3
              }
              UINT8 Receive_Data_From_UART1(void)
              {
                  UINT8 c;
                  
                  while (!RI_1);
                  c = SBUF_1;
                  RI_1 = 0;
                  return (c);
              }
              
              void Send_Data_To_UART1 (UINT8 c)
              {
                  TI_1 = 0;
                  SBUF_1 = c;
                  while(TI_1==0);
              }
              char putchar (char c)
              {
                              while (!TI_1);  /* wait until transmitter ready */
                              TI_1 = 0;
                              SBUF_1 = c;      /* output character */
                              return (c);
              }
              #endif
 112          /*********************************************************************************************************
             -***
 113          *    TIMER 0 interrupt subroutine
 114          **********************************************************************************************************
             -**/
C51 COMPILER V9.54   MAIN                                                                  05/31/2019 01:35:39 PAGE 3   

 115          void Timer0_ISR (void) interrupt 1          //interrupt address is 0x000B
 116          {
 117   1          TH0 = TH0_INIT;
 118   1          TL0 = TL0_INIT;
 119   1              is_5ms_Flag = 1;
 120   1              dpdtime++;
 121   1              startADC_cnt ++;
 122   1              led_display_time++;
 123   1      }
 124          
 125          void Timer0_Init(void)
 126          {
 127   1              TMOD = 0XFF;
 128   1              TIMER0_MODE1_ENABLE;                        //Timer 0  mode configuration
 129   1          
 130   1              clr_T0M;
 131   1          
 132   1              TH0 = TH0_INIT;
 133   1              TL0 = TL0_INIT;
 134   1          
 135   1              set_ET0;                                    //enable Timer0 interrupt
 136   1              set_EA;                                     //enable interrupts
 137   1              
 138   1              set_TR0;                                    //Timer0 run
 139   1      }
 140          
 141          unsigned int getadcvalue(void)
 142          {
 143   1              unsigned char i;
 144   1              unsigned int adcvalue_temp;
 145   1              adcvalue_temp = 0;
 146   1              for(i=0;i<ADC_CNT;i++)
 147   1              {
 148   2                      adcvalue_temp += adc[i];
 149   2              }
 150   1              adcvalue_temp >>=3;
 151   1              return adcvalue_temp;
 152   1      }
 153          
 154          unsigned int charging_bat_feedback(unsigned int cur_adc,unsigned char pwm)
 155          {
 156   1              unsigned int temp;
 157   1              unsigned int temp_pwm;
 158   1              if (pwm == 1)
 159   1              {
 160   2                      temp_pwm = 30;
 161   2              }
 162   1              else if (pwm == 2)
 163   1              {
 164   2                      temp_pwm = 20;
 165   2              }
 166   1              else if (pwm == 3)
 167   1              {
 168   2                      temp_pwm = 10;
 169   2              }
 170   1              else
 171   1              {
 172   2                      temp_pwm = 0;
 173   2              }
 174   1              
 175   1              if (batlevel == 1)
 176   1              {
C51 COMPILER V9.54   MAIN                                                                  05/31/2019 01:35:39 PAGE 4   

 177   2                      temp = 180 - temp_pwm;
 178   2              }
 179   1              else if (batlevel == 2)
 180   1              {
 181   2                      temp = 180 - temp_pwm;
 182   2              }
 183   1              else if (batlevel == 3)
 184   1              {
 185   2                      temp = 180 - temp_pwm;
 186   2              }
 187   1              else if (batlevel == 4)
 188   1              {
 189   2                      temp = 180 - temp_pwm;
 190   2              }
 191   1              else if (batlevel == 5)
 192   1              {
 193   2                      if (cur_adc > 3400)
 194   2                      {
 195   3                              temp = 80 - temp_pwm;
 196   3                      }
 197   2                      else if (cur_adc > 3300)
 198   2                      {
 199   3                              temp = 90 - temp_pwm;
 200   3                      }
 201   2                      else
 202   2                      {
 203   3                              temp = 160 - temp_pwm;
 204   3                      }
 205   2              }
 206   1              else if (batlevel == 6)
 207   1              {
 208   2                      if (cur_adc > 3400)
 209   2                      {
 210   3                              temp = 40 - temp_pwm;
 211   3                      }
 212   2                      else if (cur_adc > 3300)
 213   2                      {
 214   3                              temp = 60 - temp_pwm;
 215   3                      }
 216   2                      else
 217   2                      {
 218   3                              temp = 130 - temp_pwm;
 219   3                      }
 220   2              }
 221   1              return temp;
 222   1      }
 223          
 224          unsigned char getbatlevel(unsigned char adc_delay)
 225          {
 226   1              unsigned char templevel;
 227   1              unsigned char motor_level;
 228   1              unsigned char cur_pwm_level;
 229   1              unsigned int adcvaluetemp;
 230   1              if (startADC_cnt > adc_delay)
 231   1              {
 232   2                      startADC_cnt = 0;
 233   2                      CKDIV = 0x04; 
 234   2                      clr_ADCF;
 235   2                      set_ADCS;                                                                       // ADC start trig signal
 236   2                      while(ADCF == 0);
 237   2                      CKDIV = 0x00; 
 238   2                      adcvaluetemp = ADCRH;
C51 COMPILER V9.54   MAIN                                                                  05/31/2019 01:35:39 PAGE 5   

 239   2                      adcvaluetemp <<= 4;
 240   2                      adcvaluetemp |= ADCRL&0x0F;
 241   2                      adc[adccnt] = adcvaluetemp;
 242   2                      adccnt++;
 243   2                      if (adccnt >= ADC_CNT)
 244   2                      {
 245   3                              adccnt = 0;
 246   3                              if (adc_dis_cnt > 0)
 247   3                                      return 0;
 248   3                              adcvaluetemp = getadcvalue();
 249   3                              #if UART_TEST
                                      printf("\n adcvaluetemp=%d",adcvaluetemp);
                                      #endif
 252   3                              motor_level = get_motor_level();
 253   3                              
 254   3                              if (motor_level == 1)
 255   3                              {
 256   4                                      cur_pwm_level = cur_pwm();
 257   4                                      if (cur_pwm_level == 1)
 258   4                                              adcvaluetemp = adcvaluetemp + 0x18;
 259   4                                      else if (cur_pwm_level == 2)
 260   4                                              adcvaluetemp = adcvaluetemp + 0x28;
 261   4                                      else
 262   4                                              adcvaluetemp = adcvaluetemp + 0x30;
 263   4                              }
 264   3                              else if (motor_level == 2)
 265   3                              {
 266   4                                      adcvaluetemp = adcvaluetemp + 0x28;
 267   4                              }
 268   3                              else if (motor_level == 4)
 269   3                              {
 270   4                                      adcvaluetemp = adcvaluetemp + 0x18;
 271   4                              }
 272   3                              if (ischarging)
 273   3                              {
 274   4                                      if (isWaitTurnOffCharging == 0)
 275   4                                              adcvaluetemp = adcvaluetemp - charging_bat_feedback(adcvaluetemp,motor_level);
 276   4                                      else
 277   4                                      {
 278   5                                              
 279   5                                      }
 280   4                              }
 281   3                              if (isfirstenterdpd == 0)
 282   3                              {
 283   4                                      if (adcvaluetemp < 3100)
 284   4                                              adcvalue = 3100;
 285   4                                      else if (adcvaluetemp > 3400)
 286   4                                              adcvalue = 3300;
 287   4                                      else 
 288   4                                              adcvalue = adcvaluetemp;
 289   4                              }
 290   3                              if (isstartsystem == 1)
 291   3                              {
 292   4                                      if (adcvalue == 0)
 293   4                                              adcvalue = adcvaluetemp;
 294   4                                      if (adcvaluetemp > (adcvalue + 8))
 295   4                                      {
 296   5                                              adcchangecnt++;
 297   5                                              if (adcchangecnt > 8)
 298   5                                              {
 299   6                                                      adcchangecnt = 0;
 300   6                                                      adcvalue+=5;
C51 COMPILER V9.54   MAIN                                                                  05/31/2019 01:35:39 PAGE 6   

 301   6                                              }
 302   5                                      }
 303   4                                      else if (adcvaluetemp < (adcvalue-8))
 304   4                                      {
 305   5                                              adcchangecnt = 0;
 306   5                                              adcvalue-=5;
 307   5                                      }
 308   4                                      else
 309   4                                      {
 310   5                                              adcchangecnt = 0;
 311   5                                      }
 312   4                              }               
 313   3                              
 314   3                              #if UART_TEST
                                      printf("\n adcvalue=%d",adcvalue);
                                      bat_val = ((float)adcvalue) *3.34 /4096.0 * 3.0;
                                      printf("\n bat=%0.4f",bat_val);
                                      #endif
 319   3                              if (adcvalue > 0xCD0)           //100% 8.2
 320   3                              {
 321   4                                      templevel = 6;
 322   4                                      if(ischarging == 1)
 323   4                                      {
 324   5                                              isWaitTurnOffCharging = 1;
 325   5                                      }
 326   4                              }
 327   3                              else if (adcvalue > 0xCA0)      //>75%  7.9v            
 328   3                              {
 329   4                                      templevel = 5;
 330   4                              }
 331   3                              else if (adcvalue > 0xC40)      //>50%  7.7v
 332   3                              {
 333   4                                      templevel = 4;
 334   4                              }
 335   3                              else if (adcvalue > 0xBE0)      //>25%  7.5
 336   3                              {
 337   4                                      templevel = 3;
 338   4                              }
 339   3                              else if (adcvalue > 0xBA0)      //10%   7.2v
 340   3                              {
 341   4                                      templevel = 2;
 342   4                              }
 343   3                              else
 344   3                              {
 345   4                                      templevel = 1;
 346   4                              }
 347   3                              if (isWaitTurnOffCharging == 0)
 348   3                              {
 349   4                                      if (batlevel != templevel)
 350   4                                              adc_pre_cnt++;
 351   4                                      else
 352   4                                              adc_pre_cnt = 0;
 353   4                                      if (adc_pre_cnt > 5)
 354   4                                      {
 355   5                                              adc_pre_cnt = 0;
 356   5                                              if (ischarging)
 357   5                                              {
 358   6                                                      if (templevel > batlevel)
 359   6                                                      {
 360   7                                                              batlevel = templevel;
 361   7                                                      }
 362   6                                              }
C51 COMPILER V9.54   MAIN                                                                  05/31/2019 01:35:39 PAGE 7   

 363   5                                              else if(motor_level != 0)
 364   5                                              {
 365   6                                                      if (templevel < batlevel)
 366   6                                                      {
 367   7                                                              batlevel = templevel;
 368   7                                                      }
 369   6                                              }
 370   5                                              else
 371   5                                              {
 372   6                                                      batlevel = templevel;
 373   6                                              }
 374   5                                      }
 375   4                              }
 376   3                              return 1;
 377   3                      }
 378   2              }       
 379   1              return 0;
 380   1      }
 381          
 382          void P05_wakeup_init(void){
 383   1              P05_Input_Mode;
 384   1              
 385   1              PINEN = 0x20;
 386   1              PIPEN = 0x00;
 387   1              PICON = 0x40;
 388   1              
 389   1              set_EPI;
 390   1              
 391   1              set_EA;
 392   1      }
 393          void Enter_DPD(void)
 394          {
 395   1              dpdtime = 0;
 396   1              //enter dpd
 397   1              //
 398   1              Set_All_GPIO_Quasi_Mode;
 399   1              clr_ADCEN;
 400   1      
 401   1              TurnOffMotor();
 402   1              LED_WHITE_Setting(0);
 403   1              LED_RGB_Setting(0);
 404   1              DeInit_LED();
 405   1      
 406   1              P05_wakeup_init();
 407   1      
 408   1              P17_Input_Mode;
 409   1              set_P1S_7;
 410   1              set_EX1;
 411   1                                              
 412   1              set_PD;
 413   1      
 414   1              PICON  = 0;
 415   1                                      
 416   1              clr_EX0;
 417   1              clr_EX1;
 418   1              clr_EPI;
 419   1              isneedinitsys = 1;      
 420   1      }
 421          
 422          void SysInit(void)
 423          {       
 424   1              #if UART_TEST
C51 COMPILER V9.54   MAIN                                                                  05/31/2019 01:35:39 PAGE 8   

                      InitialUART1_Timer3(115200);
                      TI_1 = 1;
                      #endif
 428   1              Init_LED();
 429   1              Timer0_Init();  
 430   1              startADC_cnt = 0;
 431   1              adccnt = 0;
 432   1              KeyInit();      
 433   1              InitPWM();
 434   1              system_stage = Stage_A;
 435   1              isneedinitstage = 1;
 436   1              batlevelledtimeout = 0; 
 437   1              batlevel_led_value = 0;
 438   1              ischarging = 0;
 439   1              adc_pre_cnt = 0;
 440   1              adcvalue = 0;
 441   1              Enable_ADC_AIN2;
 442   1              
 443   1              if (isstartsystem != 1)
 444   1              {
 445   2                      dpdtime = 0;
 446   2                      while(dpdtime<200)
 447   2                      {
 448   3                              if (P05 == 0)
 449   3                                      ischarging = 1;
 450   3                              getbatlevel(0);
 451   3                      }
 452   2                      isstartsystem = 1;
 453   2                      DPD_CNT = 2000;
 454   2              }
 455   1              dpdtime = 0;
 456   1              led_display_time = 0;
 457   1              startADC_cnt = 0;
 458   1              if (isfirstenterdpd == 1)
 459   1                      adc_dis_cnt = 200;
 460   1              isWaitTurnOffCharging = 0;
 461   1      }
 462          
 463          
 464          void main(void)
 465          {
 466   1              unsigned char keystatus,i;
 467   1              Set_All_GPIO_Quasi_Mode;
 468   1              isneedinitsys = 1;
 469   1              isstartsystem = 0;
 470   1              isfirstenterdpd = 0;
 471   1              while(1)
 472   1              {
 473   2                      if (isneedinitsys)
 474   2                      {
 475   3                              SysInit();
 476   3                              isneedinitsys = 0;
 477   3                      }
 478   2                      if (is_5ms_Flag)
 479   2                      {
 480   3                              if (batlevelledtimeout)
 481   3                                      batlevelledtimeout--;
 482   3                              keystatus = KeyScan();          //keystatus->0:null；1：按键；2：安全开关；4：充电；8：长按
 483   3                              if (system_stage == Stage_A)    //没用充电，安全开关没闭合
 484   3                              {
 485   4                                      if (isneedinitstage == 1)
 486   4                                      {
C51 COMPILER V9.54   MAIN                                                                  05/31/2019 01:35:39 PAGE 9   

 487   5                                              isneedinitstage = 0;
 488   5                                              //init stage A
 489   5                                              TurnOffMotor();
 490   5                                              LED_Setting(0);
 491   5                                              LED_RGB_Setting(0);
 492   5                                              dpdtime = 0;
 493   5                                              ischarging = 0;
 494   5                                              adccnt = 0;
 495   5                                              
 496   5                                              if (isfirstenterdpd == 1)
 497   5                                              adc_dis_cnt = 200;
 498   5                                      }
 499   4                                      if (keystatus & 0x01)//key
 500   4                                      {
 501   5                                              //display power as LED
 502   5                                              batlevelledtimeout = 600;
 503   5                                              LED_Setting(system_stage);
 504   5                                      }
 505   4                                      if (keystatus & 0x02)
 506   4                                      {
 507   5                                              system_stage = Stage_B;
 508   5                                              isneedinitstage = 1;
 509   5                                      }
 510   4                                      if (keystatus & 0x04)
 511   4                                      {
 512   5                                              system_stage = Stage_C;
 513   5                                              isneedinitstage = 1;
 514   5                                      }                       
 515   4                              }
 516   3                              else if (system_stage == Stage_B)       //闭合安全开关
 517   3                              {
 518   4                                      if (isneedinitstage == 1)
 519   4                                      {
 520   5                                              isneedinitstage = 0;
 521   5                                              //init stage B
 522   5                                              dpdtime = 0;
 523   5                                              ischarging = 0;
 524   5                                              //check motor level
 525   5                                              i = get_motor_level();                                  
 526   5                                              LED_RGB_Setting(i);
 527   5                                              if (i == 0)
 528   5                                                      LED_Setting(0);
 529   5                                              else
 530   5                                                      LED_Setting(system_stage);
 531   5                                              led_display_time = 600;
 532   5                                              adccnt = 0;
 533   5                                              if (isfirstenterdpd == 1)
 534   5                                              adc_dis_cnt = 200;
 535   5                                      }
 536   4                                      if (keystatus & 0x01)//key
 537   4                                      {
 538   5                                              //change pwm
 539   5                                              i  = Change_Motor_PWM();
 540   5                                              LED_RGB_Setting(i);
 541   5      //                                      if (i == 0)
 542   5      //                                              LED_Setting(0);
 543   5      //                                      else
 544   5                                                      LED_Setting(system_stage);
 545   5                                              adccnt = 0;
 546   5                                              if (isfirstenterdpd == 1)
 547   5                                              adc_dis_cnt = 200;
 548   5                                      }
C51 COMPILER V9.54   MAIN                                                                  05/31/2019 01:35:39 PAGE 10  

 549   4                                      if (keystatus & 0x02)//safety
 550   4                                      {
 551   5                                      }
 552   4                                      else
 553   4                                      {
 554   5                                              system_stage = Stage_A;
 555   5                                              isneedinitstage = 1;
 556   5                                              //turn off pwm
 557   5                                              TurnOffMotor();
 558   5                                              LED_RGB_Setting(0);
 559   5                                              LED_Setting(0);
 560   5                                      }
 561   4                                      
 562   4                                      if (keystatus & 0x04)//charging
 563   4                                      {
 564   5                                              system_stage = Stage_D;
 565   5                                              isneedinitstage = 1;
 566   5                                      }
 567   4                                      
 568   4                                      if (keystatus & 0x08)
 569   4                                      {
 570   5                                              //turn off pwm
 571   5                                              TurnOffMotor();
 572   5                                              LED_RGB_Setting(0);
 573   5      //                                      LED_Setting(0);
 574   5                                              adccnt = 0;
 575   5                                              if (isfirstenterdpd == 1)
 576   5                                              adc_dis_cnt = 200;
 577   5                                      }
 578   4                              }
 579   3                              else if (system_stage == Stage_C)       //充电中
 580   3                              {
 581   4                                      if (isneedinitstage == 1)
 582   4                                      {
 583   5                                              isneedinitstage = 0;
 584   5                                              //init stage C  
 585   5                                              dpdtime = 0;
 586   5                                              ischarging = 1;                                 
 587   5                                              TurnOffMotor();
 588   5                                              LED_RGB_Setting(0);
 589   5                                              LED_Setting(system_stage);
 590   5                                              led_display_time = 600;
 591   5                                              adccnt = 0;
 592   5                                              if (isfirstenterdpd == 1)
 593   5                                              adc_dis_cnt = 200;
 594   5                                      }
 595   4                                      if (keystatus & 0x01)//key
 596   4                                      {
 597   5                                              
 598   5                                      }
 599   4                                      if (keystatus & 0x02)//safety
 600   4                                      {
 601   5                                              //enter stage_B
 602   5                                              system_stage = Stage_D;
 603   5                                              isneedinitstage = 1;
 604   5                                      }
 605   4                                      
 606   4                                      if (keystatus & 0x04)//charging
 607   4                                      {
 608   5                                              dpdtime = 0;
 609   5                                      }
 610   4                                      else
C51 COMPILER V9.54   MAIN                                                                  05/31/2019 01:35:39 PAGE 11  

 611   4                                      {
 612   5                                              system_stage = Stage_A;
 613   5                                              ischarging = 0;
 614   5                                              LED_Setting(0);
 615   5                                              isneedinitstage = 1;
 616   5                                      }
 617   4                              }
 618   3                              else if (system_stage == Stage_D)       //充电和闭合安全开关
 619   3                              {
 620   4                                      if (isneedinitstage == 1)
 621   4                                      {
 622   5                                              isneedinitstage = 0;
 623   5                                              //init stage D
 624   5                                              dpdtime = 0;
 625   5                                              ischarging = 1;
 626   5                                              //check motor level
 627   5                                              i = get_motor_level();                                  
 628   5                                              LED_RGB_Setting(i);
 629   5                                              LED_Setting(system_stage);
 630   5                                              adccnt = 0;
 631   5                                              if (isfirstenterdpd == 1)
 632   5                                              adc_dis_cnt = 200;
 633   5                                      }
 634   4                                      if (keystatus & 0x01)//key
 635   4                                      {
 636   5                                              //change pwm
 637   5                                              i  = Change_Motor_PWM();
 638   5                                              LED_RGB_Setting(i);
 639   5                                              adccnt = 0;
 640   5                                              if (isfirstenterdpd == 1)
 641   5                                              adc_dis_cnt = 200;
 642   5                                      }
 643   4                                      if (keystatus & 0x02)//safety
 644   4                                      {
 645   5                                      }
 646   4                                      else
 647   4                                      {
 648   5                                              system_stage = Stage_C;
 649   5                                              isneedinitstage = 1;
 650   5                                              TurnOffMotor();
 651   5                                              LED_RGB_Setting(0);
 652   5                                      }
 653   4                                      
 654   4                                      if (keystatus & 0x04)//charging
 655   4                                      {
 656   5                                              dpdtime = 0;
 657   5                                      }
 658   4                                      else
 659   4                                      {
 660   5                                              system_stage = Stage_B;
 661   5                                              ischarging = 0;
 662   5                                              i = get_motor_level();
 663   5                                              LED_RGB_Setting(i);
 664   5      //                                      if (i == 0)
 665   5      //                                              LED_Setting(0);
 666   5      //                                      else
 667   5                                                      LED_Setting(system_stage);                              
 668   5                                              isneedinitstage = 1;
 669   5                                      }
 670   4                                      
 671   4                                      if (keystatus & 0x08)
 672   4                                      {
C51 COMPILER V9.54   MAIN                                                                  05/31/2019 01:35:39 PAGE 12  

 673   5                                              //turn off pwm
 674   5                                              TurnOffMotor();
 675   5                                              LED_RGB_Setting(0);
 676   5      //                                      LED_Setting(system_stage);
 677   5                                              adccnt = 0;
 678   5                                              if (isfirstenterdpd == 1)
 679   5                                              adc_dis_cnt = 200;
 680   5                                      }
 681   4                              }
 682   3                              
 683   3                              //ADC process
 684   3                              if(adc_dis_cnt > 0)
 685   3                              {
 686   4                                      adc_dis_cnt--;
 687   4                              }
 688   3      //                      else
 689   3                              {
 690   4                                      getbatlevel(5);
 691   4                              }
 692   3                              if (isWaitTurnOffCharging == 1)
 693   3                              {
 694   4                                      if (keystatus & 0x04)
 695   4                                      {
 696   5                                              batlevel = 6;
 697   5                                      }
 698   4                                      else
 699   4                                      {
 700   5                                              isWaitTurnOffCharging = 0;
 701   5                                      }
 702   4                              }
 703   3                              //pwm rate
 704   3                              if (check_motor_done())
 705   3                              {
 706   4                                      //turn off pwm
 707   4                                      TurnOffMotor();
 708   4                                      LED_RGB_Setting(0);
 709   4      //                              LED_Setting(0);
 710   4                                      isneedinitstage = 1;
 711   4                                      adccnt = 0;
 712   4                                      if (isfirstenterdpd == 1)
 713   4                                      adc_dis_cnt = 200;
 714   4                              }
 715   3                              if(get_motor_level())
 716   3                              {
 717   4                                      dpdtime = 0;
 718   4                              }
 719   3                              //LED_Process           
 720   3                              LED_Process(system_stage);
 721   3                              
 722   3                              //dpd
 723   3                              if (dpdtime >= DPD_CNT)
 724   3                              {
 725   4                                      DPD_CNT = 2000;
 726   4                                      isfirstenterdpd = 1;
 727   4                                      Enter_DPD();
 728   4                              }
 729   3                      }
 730   2              }
 731   1      }
 732          
 733          void EXT_INT1(void) interrupt 2
 734          {
C51 COMPILER V9.54   MAIN                                                                  05/31/2019 01:35:39 PAGE 13  

 735   1              
 736   1      }
 737          
 738          void PinInterrupt_ISR (void) interrupt 7
 739          {
 740   1              if(PIF == 0x10) //pin 0
 741   1                      MOTOR_FG_PinInterrupt_ISR();
 742   1              PIF = 0x00;
 743   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1574    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     33       6
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      7    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
