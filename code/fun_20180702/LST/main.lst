C51 COMPILER V9.54   MAIN                                                                  09/24/2019 22:21:40 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Output\main.obj
COMPILER INVOKED BY: D:\keil\C51\BIN\C51.EXE Code\main.c ROM(COMPACT) OPTIMIZE(8,SIZE) BROWSE INCDIR(..\..\Include;..\In
                    -clude) DEFINE(FOSC_160000) DEBUG OBJECTEXTEND PRINT(.\LST\main.lst) OBJECT(.\Output\main.obj)

line level    source

   1          
   2          #include "N76E003.h"
   3          #include "SFR_Macro.h"
   4          #include "Function_define.h"
   5          #include "dataflash.h"
   6          #include "key.h"
   7          #include "motor.h"
   8          #include "led.h"
   9          #include "Delay.h"
  10          
  11          #define TH0_INIT        (65536-6667)/256 //5.0ms@XTAL=12MHz, Period = (10.85/2) ms@XTAL=22.1184MHz
  12          #define TL0_INIT        (65536-6667)%256
  13          #define TH1_INIT        0xE0 //2.5ms@XTAL=12MHz, Period = (5.425/2) ms@XTAL=22.1184MHz
  14          #define TL1_INIT        0x00
  15          
  16          bit BIT_TMP;
  17          #define ADC_CNT 8
  18          
  19          extern unsigned char Motor_Level;
  20          extern unsigned int led_display_time;
  21          /********************************/
  22          #define Stage_A         1
  23          #define Stage_B         2
  24          #define Stage_C         4
  25          #define Stage_D         8
  26          
  27          bit isneedinitstage;
  28          bit isneedinitsys;
  29          bit ischarging;
  30          bit isstartsystem;
  31          bit isWaitTurnOffCharging;
  32          bit isfirstenterdpd;
  33          bit isenableLED;
  34          sbit powerfull = P2^0;
  35          unsigned char is_5ms_Flag;
  36          unsigned char system_stage;
  37          
  38          unsigned char batlevel_led_value;
  39          unsigned char adc_pre_cnt;
  40          unsigned char adccnt;
  41          unsigned char batlevel;
  42          unsigned char adc_dis_cnt;
  43          unsigned char adcchangecnt=0;
  44          
  45          unsigned int startADC_cnt;
  46          unsigned int first_run_times;
  47          unsigned int adc_wait_cnt;
  48          unsigned int dpdtime;
  49          unsigned int batlevelledtimeout;
  50          unsigned int adcvalue;
  51          unsigned int adc[ADC_CNT];
  52          int testtemp;
  53          
  54          #define UART_TEST       1
C51 COMPILER V9.54   MAIN                                                                  09/24/2019 22:21:40 PAGE 2   

  55          #define WDT_ENABLE      1
  56          
  57          #if UART_TEST
  58          
  59          float bat_val;
  60          /*******************************/
  61          typedef unsigned char         UINT8;
  62          typedef unsigned int          UINT16;
  63          typedef unsigned long         UINT32;
  64          
  65          typedef unsigned char         uint8_t;
  66          typedef unsigned int          uint16_t;
  67          typedef unsigned long         uint32_t;
  68          /*uart1*/
  69          void InitialUART1_Timer3(UINT32 u32Baudrate) //use timer3 as Baudrate generator
  70          {
  71   1                      P02_Quasi_Mode;         //Setting UART pin as Quasi mode for transmit
  72   1                      P16_Quasi_Mode;         //Setting UART pin as Quasi mode for transmit
  73   1              
  74   1                SCON_1 = 0x50;        //UART1 Mode1,REN_1=1,TI_1=1
  75   1          T3CON = 0x08;       //T3PS2=0,T3PS1=0,T3PS0=0(Prescale=1), UART1 in MODE 1
  76   1                      clr_BRCK;
  77   1              
  78   1      #ifdef FOSC_160000
  79   1                      RH3    = HIBYTE(65536 - (1000000/u32Baudrate)-1);               /*16 MHz */
  80   1                      RL3    = LOBYTE(65536 - (1000000/u32Baudrate)-1);                       /*16 MHz */
  81   1      #endif
  82   1      #ifdef FOSC_166000
                              RH3    = HIBYTE(65536 - (1037500/u32Baudrate));                         /*16.6 MHz */
                              RL3    = LOBYTE(65536 - (1037500/u32Baudrate));                         /*16.6 MHz */
              #endif
  86   1          set_TR3;         //Trigger Timer3
  87   1      }
  88          UINT8 Receive_Data_From_UART1(void)
  89          {
  90   1          UINT8 c;
  91   1          
  92   1          while (!RI_1);
  93   1          c = SBUF_1;
  94   1          RI_1 = 0;
  95   1          return (c);
  96   1      }
  97          
  98          void Send_Data_To_UART1 (UINT8 c)
  99          {
 100   1          TI_1 = 0;
 101   1          SBUF_1 = c;
 102   1          while(TI_1==0);
 103   1      }
 104          char putchar (char c)
 105          {
 106   1                      while (!TI_1);  /* wait until transmitter ready */
 107   1                      TI_1 = 0;
 108   1                      SBUF_1 = c;      /* output character */
 109   1                      return (c);
 110   1      }
 111          
 112          void Timer1_Delay100us(unsigned long cnt)
 113          {
 114   1          clr_T1M;                                                                                                                                            //T1M=0, Timer1 Clock = Fsys/12
 115   1          TMOD |= 0x10;                                                                                                                               //Timer1 is 16-bit mode
 116   1          set_TR1;                                                                                                                                            //Start Timer1
C51 COMPILER V9.54   MAIN                                                                  09/24/2019 22:21:40 PAGE 3   

 117   1          while (cnt != 0)
 118   1          {
 119   2              TL1 = LOBYTE(TIMER_DIV12_VALUE_100us);          //Find  define in "Function_define.h" "TIMER VALUE"
 120   2              TH1 = HIBYTE(TIMER_DIV12_VALUE_100us);
 121   2              while (TF1 != 1);                                                                                               //Check Timer1 Time-Out Flag
 122   2              clr_TF1;
 123   2              cnt --;
 124   2          }
 125   1          clr_TR1;                                                    //Stop Timer1
 126   1      }
 127          #endif
 128          /*********************************************************************************************************
             -***
 129          *    TIMER 0 interrupt subroutine
 130          **********************************************************************************************************
             -**/
 131          void Timer0_ISR (void) interrupt 1          //interrupt address is 0x000B
 132          {
 133   1          TH0 = TH0_INIT;
 134   1          TL0 = TL0_INIT;
 135   1              is_5ms_Flag = 1;
 136   1              dpdtime++;
 137   1              startADC_cnt ++;
 138   1              led_display_time++;
 139   1              adc_wait_cnt++;
 140   1              if (first_run_times < 2000) 
 141   1                      first_run_times++;
 142   1      }
 143          void Timer0_Init(void)
 144          {
 145   1              TMOD = 0XFF;
 146   1              TIMER0_MODE1_ENABLE;                        //Timer 0  mode configuration
 147   1          
 148   1              clr_T0M;
 149   1          
 150   1              TH0 = TH0_INIT;
 151   1              TL0 = TL0_INIT;
 152   1          
 153   1              set_ET0;                                    //enable Timer0 interrupt
 154   1              set_EA;                                     //enable interrupts
 155   1              
 156   1              set_TR0;                                    //Timer0 run
 157   1      }
 158          
 159          unsigned int getadcvalue(unsigned int * buf)
 160          {
 161   1              unsigned char i;
 162   1              unsigned int adcvalue_temp;
 163   1              adcvalue_temp = 0;
 164   1              for(i=0;i<ADC_CNT;i++)
 165   1              {
 166   2                      adcvalue_temp += buf[i];
 167   2              }
 168   1              adcvalue_temp >>=3;
 169   1              return adcvalue_temp;
 170   1      }
 171          
 172          unsigned int charging_bat_feedback(unsigned int cur_adc,unsigned char pwm)
 173          {
 174   1              unsigned int temp;
 175   1              unsigned int temp_pwm;
 176   1              
C51 COMPILER V9.54   MAIN                                                                  09/24/2019 22:21:40 PAGE 4   

 177   1      //      if (pwm == 0)
 178   1              {
 179   2                      if (batlevel < 3)
 180   2                      {
 181   3                              temp = 180;
 182   3                      }
 183   2                      else if (batlevel <5)
 184   2                      {
 185   3                              temp = 120;
 186   3                      }
 187   2                      else 
 188   2                      {
 189   3                              temp = 60;
 190   3                      }
 191   2              }
 192   1      //      else
 193   1      //      {
 194   1      //              if (pwm == 1)
 195   1      //              {
 196   1      //                      
 197   1      //              }
 198   1      //              else if (pwm == 2)
 199   1      //              {
 200   1      //              }
 201   1      //              else if (pwm == 4)
 202   1      //              {
 203   1      //              }
 204   1      //              
 205   1      //      }
 206   1              
 207   1              return temp;
 208   1      }
*** WARNING C280 IN LINE 172 OF Code\main.c: 'cur_adc': unreferenced local variable
*** WARNING C280 IN LINE 172 OF Code\main.c: 'pwm': unreferenced local variable
*** WARNING C280 IN LINE 175 OF Code\main.c: 'temp_pwm': unreferenced local variable
 209          
 210          unsigned char getbatlevel(unsigned char adc_delay)
 211          {
 212   1              unsigned char templevel;
 213   1              unsigned char cur_pwm_level;
 214   1              unsigned int adcvaluetemp;
 215   1              if (startADC_cnt > adc_delay)
 216   1              {
 217   2                      CKDIV = 0x04; 
 218   2                      clr_ADCF;
 219   2                      set_ADCS;                                                                       // ADC start trig signal
 220   2                      while(ADCF == 0);
 221   2                      CKDIV = 0x00; 
 222   2                      adcvaluetemp = ADCRH;
 223   2                      adcvaluetemp <<= 4;
 224   2                      adcvaluetemp |= ADCRL&0x0F;
 225   2                      adc[adccnt] = adcvaluetemp;
 226   2                      adccnt++;
 227   2                      startADC_cnt = 0;
 228   2                      adc_wait_cnt=0;
 229   2                      if (adccnt >= ADC_CNT)
 230   2                      {
 231   3                              adccnt = 0;
 232   3                              if(adc_dis_cnt > 0)
 233   3                              {
 234   4                                      return 0;
 235   4                              }
C51 COMPILER V9.54   MAIN                                                                  09/24/2019 22:21:40 PAGE 5   

 236   3                              adcvaluetemp = getadcvalue(adc);
 237   3                              
 238   3                              if (ischarging)
 239   3                              {
 240   4                                      if (Motor_Level == 0)
 241   4                                      {                                                                               
 242   5                                              if (adcvaluetemp < 3000)
 243   5                                                      adcvaluetemp = adcvaluetemp-50;
 244   5                                              else if (adcvaluetemp < 3200)
 245   5                                                      adcvaluetemp = adcvaluetemp-20;
 246   5                                      }
 247   4                              }
 248   3                              else if (Motor_Level)
 249   3                              {
 250   4                                      if (Motor_Level == 1)
 251   4                                      {
 252   5                                              cur_pwm_level = cur_pwm();
 253   5                                              if (cur_pwm_level == 1)
 254   5                                                      adcvaluetemp = adcvaluetemp + 60;
 255   5                                              else if (cur_pwm_level == 2)
 256   5                                                      adcvaluetemp = adcvaluetemp + 80;
 257   5                                              else
 258   5                                                      adcvaluetemp = adcvaluetemp + 120;
 259   5                                      }
 260   4                                      else if (Motor_Level == 2)
 261   4                                      {
 262   5                                              adcvaluetemp = adcvaluetemp + 80;
 263   5                                      }
 264   4                                      else if (Motor_Level == 4)
 265   4                                      {
 266   5                                              adcvaluetemp = adcvaluetemp + 60;
 267   5                                      }
 268   4                              }
 269   3                              
 270   3                              #if UART_TEST
 271   3                              printf("ap=%d\n",adcvaluetemp);//adcvaluetemp
 272   3                              #endif
 273   3                              if (isstartsystem == 1)
 274   3                              {
 275   4                                      if (ischarging)
 276   4                                      {
 277   5      //                                      if (powerfull == 0)
 278   5      //                                      {
 279   5      //                                              isWaitTurnOffCharging = 1;
 280   5      //                                              templevel = 6;
 281   5      //                                      }
 282   5                                              if (adcvaluetemp > (adcvalue + 8))
 283   5                                              {
 284   6                                                      adcchangecnt++;
 285   6                                                      if (adcchangecnt > 3)
 286   6                                                      {
 287   7                                                              adcchangecnt = 0;
 288   7                                                              adcvalue+=(adcvaluetemp - adcvalue)>>1;
 289   7                                                      }
 290   6                                              }
 291   5                                              else if (adcvaluetemp < (adcvalue-8))
 292   5                                              {
 293   6                                                      adcchangecnt = 0;
 294   6                                                      adcvalue-=5;
 295   6                                              }
 296   5                                              else
 297   5                                              {
C51 COMPILER V9.54   MAIN                                                                  09/24/2019 22:21:40 PAGE 6   

 298   6                                                      adcchangecnt = 0;
 299   6                                              }
 300   5                                      }
 301   4                                      else
 302   4                                      {
 303   5                                              if (adcvaluetemp > (adcvalue + 8))
 304   5                                              {
 305   6                                                      adcchangecnt++;
 306   6                                                      if (adcchangecnt > 5)
 307   6                                                      {
 308   7                                                              adcchangecnt = 0;
 309   7                                                              adcvalue+=5;
 310   7                                                      }
 311   6                                              }
 312   5                                              else if (adcvaluetemp < (adcvalue-8))
 313   5                                              {
 314   6                                                      adcchangecnt = 0;
 315   6                                                      adcvalue-=5;
 316   6                                              }
 317   5                                              else
 318   5                                              {
 319   6                                                      adcchangecnt = 0;
 320   6                                              }
 321   5                                      }
 322   4                                      if (adcvalue == 0)
 323   4                                              adcvalue = adcvaluetemp;                                
 324   4                              }
 325   3                              #if UART_TEST
 326   3                              printf("ae=%d\n",adcvalue);//adcvalue
 327   3      //                      bat_val = ((float)adcvalue) *3.34 /4096.0 * 3.0;
 328   3      //                      printf("bat=%0.4f\n",bat_val);
 329   3                              #endif
 330   3                              if (adcvalue > 3300)            //100% 8.2
 331   3                              {
 332   4                                      templevel = 6;
 333   4                                      if(ischarging == 1)
 334   4                                      {
 335   5                                              isWaitTurnOffCharging = 1;
 336   5                                      }
 337   4                              }
 338   3                              else if (adcvalue > 3180)       //>75%  7.9v    0xCA0   
 339   3                              {
 340   4                                      templevel = 5;
 341   4                              }
 342   3                              else if (adcvalue > 3050)       //>50%  7.7v    0xC40
 343   3                              {
 344   4                                      templevel = 4;
 345   4                              }
 346   3                              else if (adcvalue > 2980)       //>25%  7.5             0xBE0
 347   3                              {
 348   4                                      templevel = 3;
 349   4                              }
 350   3                              else if (adcvalue > 2830)       //10%   7.2v    0xBA0
 351   3                              {
 352   4                                      templevel = 2;
 353   4                              }
 354   3                              else
 355   3                              {
 356   4                                      templevel = 1;
 357   4                              }
 358   3                              if (isWaitTurnOffCharging == 0)
 359   3                              {
C51 COMPILER V9.54   MAIN                                                                  09/24/2019 22:21:40 PAGE 7   

 360   4                                      if (batlevel != templevel)
 361   4                                              adc_pre_cnt++;
 362   4                                      else
 363   4                                              adc_pre_cnt = 0;
 364   4                                      #if UART_TEST                           
 365   4                                      testtemp = batlevel;
 366   4                                      printf("pl=%d\n",testtemp);//power level
 367   4                                      testtemp = templevel;
 368   4                                      printf("tl=%d\n",testtemp);//templevel
 369   4                                      testtemp = adc_pre_cnt;
 370   4                                      printf("at=%d\n",testtemp);//adc_pre_cnt
 371   4                                      #endif
 372   4                                      if (adc_pre_cnt > 5)
 373   4                                      {
 374   5                                              adc_pre_cnt = 0;
 375   5                                              if (ischarging)
 376   5                                              {
 377   6                                                      if (templevel > batlevel)
 378   6                                                      {
 379   7                                                              batlevel = templevel;
 380   7                                                      }
 381   6                                              }
 382   5                                              else if(Motor_Level != 0)
 383   5                                              {
 384   6                                                      if (templevel < batlevel)
 385   6                                                      {
 386   7                                                              batlevel = templevel;
 387   7                                                      }
 388   6                                              }
 389   5                                              else
 390   5                                              {
 391   6                                                      batlevel = templevel;
 392   6                                              }
 393   5                                      }
 394   4                              }
 395   3                              else
 396   3                              {
 397   4                                      batlevel = 6;
 398   4                              }
 399   3                              return 1;
 400   3                      }
 401   2              }       
 402   1              return 0;
 403   1      }
 404          
 405          #if WDT_ENABLE
 406          void Enable_WDT_Reset_Config(void)
 407          {
 408   1              #if 1
 409   1              set_IAPEN;
 410   1          IAPAL = 0x04;
 411   1          IAPAH = 0x00;
 412   1          IAPFD = 0x0F;
 413   1          IAPCN = 0xE1;
 414   1          set_CFUEN;
 415   1          set_IAPGO;                                  //trigger IAP
 416   1              while((CHPCON&SET_BIT6)==SET_BIT6);          //check IAPFF (CHPCON.6)
 417   1          clr_CFUEN;
 418   1          clr_IAPEN;
 419   1              #else
                      TA=0xAA;TA=0x55;WDCON=0x07;                                             //Setting WDT prescale 
                      set_WDCLR;                                                                                                              //Clear WDT timer
C51 COMPILER V9.54   MAIN                                                                  09/24/2019 22:21:40 PAGE 8   

                      while((WDCON|~SET_BIT6)==0xFF);                         //confirm WDT clear is ok before into power down mode
                      EA = 1;
                      set_WDTR;
                      #endif
 426   1      }
 427          
 428          void Disable_WDT_Reset_Config(void)
 429          {
 430   1              unsigned char cf0,cf1,cf2,cf3,cf4;
 431   1      #define     CFG_READ            0xC0
 432   1      #define     CFG_ERASE           0xE2
 433   1      #define     CFG_BYTE_PROGRAM    0xE1    
 434   1                set_IAPEN;
 435   1          IAPAL = 0x00;
 436   1          IAPAH = 0x00;
 437   1          IAPCN = CFG_READ;
 438   1          set_IAPGO;                                  //Storage CONFIG0 data
 439   1                      cf0 = IAPFD;
 440   1                      IAPAL = 0x01;
 441   1                      set_IAPGO;                                  //Storage CONFIG1 data
 442   1                      cf1 = IAPFD;
 443   1                      IAPAL = 0x02;
 444   1                set_IAPGO;                                  //Storage CONFIG2 data
 445   1                      cf2 = IAPFD;
 446   1                      IAPAL = 0x03;
 447   1                set_IAPGO;                                  //Storage CONFIG3 data
 448   1                      cf3 = IAPFD;
 449   1                      IAPAL = 0x04;
 450   1                set_IAPGO;                                  //Storage CONFIG4 data
 451   1                      cf4 = IAPFD;
 452   1                      cf4 |= 0xF0;                                                                                                                            //Moidfy Storage CONFIG4 data disable WDT reset
 453   1                      
 454   1                      set_CFUEN;      
 455   1                      IAPCN = CFG_ERASE;                                                                                                      //Erase CONFIG all
 456   1                      IAPAH = 0x00;
 457   1                      IAPAL = 0x00;
 458   1                      IAPFD = 0xFF;
 459   1                      set_IAPGO;
 460   1                      
 461   1                      IAPCN = CFG_BYTE_PROGRAM;                                                                               //Write CONFIG
 462   1                      IAPFD = cf0;
 463   1                      set_IAPGO;
 464   1                      IAPAL = 0x01;
 465   1                      IAPFD = cf1;
 466   1                      set_IAPGO;
 467   1                      IAPAL = 0x02;
 468   1                      IAPFD = cf2;
 469   1                      set_IAPGO;
 470   1                      IAPAL = 0x03;
 471   1                      IAPFD = cf3;
 472   1                      set_IAPGO;
 473   1                      IAPAL = 0x04;
 474   1                      IAPFD = cf4;
 475   1                      set_IAPGO;
 476   1      
 477   1          clr_CFUEN;
 478   1          clr_IAPEN;
 479   1      }
 480          #endif
 481          void Enter_DPD(void)
 482          {
 483   1              P06 = 1;        //enable chargine
C51 COMPILER V9.54   MAIN                                                                  09/24/2019 22:21:40 PAGE 9   

 484   1              dpdtime = 0;
 485   1      
 486   1              Set_All_GPIO_Quasi_Mode;
 487   1              clr_ADCEN;
 488   1      
 489   1              TurnOffMotor();
 490   1              LED_WHITE_Setting(0);
 491   1              LED_RGB_Setting(0);
 492   1              DeInit_LED();
 493   1              
 494   1              P05_Input_Mode; 
 495   1              while(P05 == 0);
 496   1              #if UART_TEST
 497   1              printf("P05\n");
 498   1              #endif
 499   1      //      set_P1SR_5;
 500   1      //      Enable_INT_Port0;
 501   1      //      Enable_BIT5_FallEdge_Trig;
 502   1              PICON = 0x40;   //port0
 503   1              PINEN  = 0x20;
 504   1              PIPEN = 0x00;   //IO 4  
 505   1              
 506   1              set_EPI;
 507   1              
 508   1              set_EA;
 509   1              
 510   1              P17_Input_Mode;
 511   1              #if UART_TEST
 512   1              printf("P07\n");
 513   1              #endif
 514   1              set_P1S_7;
 515   1              set_EX1;
 516   1      
 517   1              #if WDT_ENABLE
 518   1              //clear wdt
 519   1              Disable_WDT_Reset_Config();
 520   1              #endif
 521   1              
 522   1              set_PD;
 523   1      
 524   1              PICON  = 0;
 525   1                                      
 526   1              clr_EX0;
 527   1              clr_EX1;
 528   1              clr_EPI;
 529   1              isneedinitsys = 1;      
 530   1      }
 531          
 532          
 533          void SysInit(void)
 534          {       
 535   1              #if UART_TEST
 536   1              InitialUART1_Timer3(115200);
 537   1              TI_1 = 1;
 538   1              #endif
 539   1              PICON  = 0;
 540   1                                      
 541   1              clr_EX0;
 542   1              clr_EX1;
 543   1              clr_EPI;
 544   1              
 545   1              Init_LED();
C51 COMPILER V9.54   MAIN                                                                  09/24/2019 22:21:40 PAGE 10  

 546   1              Timer0_Init();  
 547   1              startADC_cnt = 0;
 548   1              adccnt = 0;
 549   1              KeyInit();      
 550   1              InitPWM();
 551   1              system_stage = Stage_A;
 552   1              isneedinitstage = 1;
 553   1              batlevelledtimeout = 0; 
 554   1              batlevel_led_value = 0;
 555   1              ischarging = 0;
 556   1              adc_pre_cnt = 0;
 557   1              adcvalue = 0;
 558   1              Enable_ADC_AIN2;
 559   1              P06_PushPull_Mode;
 560   1              dpdtime = 0;    
 561   1              if (isstartsystem != 1)
 562   1              {               
 563   2                      P06 = 0;        //disable charging
 564   2                      ischarging = 0;
 565   2                      while(dpdtime<300)
 566   2                      {
 567   3                              getbatlevel(0);
 568   3                      }
 569   2                      isstartsystem = 1;
 570   2              }
 571   1      //      else
 572   1      //      {
 573   1      //              while(dpdtime<60)
 574   1      //              {
 575   1      //                      if (P05 == 0)
 576   1      //                              ischarging = 1;
 577   1      //                      getbatlevel(0);
 578   1      //              }
 579   1      //      }
 580   1              P06 = 1;        //enable chargine
 581   1              dpdtime = 0;
 582   1              led_display_time = 0;
 583   1              startADC_cnt = 0;
 584   1              if (isfirstenterdpd == 1)
 585   1                      adc_dis_cnt = 200;
 586   1              isWaitTurnOffCharging = 0;
 587   1              
 588   1              #if UART_TEST
 589   1              printf("sysinit over\n");
 590   1              testtemp = batlevel;
 591   1              printf("power level=%d\n",testtemp);
 592   1              if (WDCON & 0x08)
 593   1              {
 594   2                      printf("wdt reset\n");
 595   2                      clr_WDTRF;
 596   2              }
 597   1              #endif
 598   1              #if WDT_ENABLE
 599   1              Enable_WDT_Reset_Config();
 600   1              #endif
 601   1              
 602   1              isenableLED = 0;
 603   1      }
 604          
 605          
 606          void main(void)
 607          {
C51 COMPILER V9.54   MAIN                                                                  09/24/2019 22:21:40 PAGE 11  

 608   1              unsigned char keystatus;
 609   1              Set_All_GPIO_Quasi_Mode;
 610   1              isneedinitsys = 1;
 611   1              isstartsystem = 0;
 612   1              isfirstenterdpd = 0;
 613   1              first_run_times= 0;
 614   1              while(1)
 615   1              {
 616   2                      if (isneedinitsys)
 617   2                      {
 618   3                              SysInit();
 619   3                              isneedinitsys = 0;
 620   3                      }
 621   2                      if (is_5ms_Flag)
 622   2                      {
 623   3                              if (batlevelledtimeout)
 624   3                                      batlevelledtimeout--;
 625   3                              keystatus = KeyScan();          //keystatus->0:null；1：按键；2：安全开关；4：充电；8：长按
 626   3                              if (system_stage == Stage_A)    //没用充电，安全开关没闭合
 627   3                              {
 628   4                                      if (isneedinitstage == 1)
 629   4                                      {
 630   5                                              #if UART_TEST
 631   5                                              printf("init stage A\n");
 632   5                                              #endif
 633   5                                              isneedinitstage = 0;
 634   5                                              //init stage A
 635   5                                              TurnOffMotor();
 636   5                                              LED_Setting(0);
 637   5                                              isenableLED = 0;
 638   5                                              LED_RGB_Setting(0);
 639   5                                              dpdtime = 0;
 640   5                                              ischarging = 0;
 641   5                                              adccnt = 0;
 642   5                                              
 643   5                                              if (isfirstenterdpd == 1)
 644   5                                              adc_dis_cnt = 200;
 645   5                                      }
 646   4                                      if (keystatus & 0x01)//key
 647   4                                      {
 648   5                                              //display power as LED
 649   5                                              batlevelledtimeout = 600;
 650   5                                              LED_Setting(system_stage);
 651   5                                              isenableLED = 1;
 652   5                                              dpdtime = 0;
 653   5                                      }
 654   4                                      if (keystatus & 0x02)
 655   4                                      {
 656   5                                              system_stage = Stage_B;
 657   5                                              isneedinitstage = 1;
 658   5                                      }
 659   4                                      if (keystatus & 0x04)
 660   4                                      {
 661   5                                              system_stage = Stage_C;
 662   5                                              isneedinitstage = 1;
 663   5                                      }                       
 664   4                              }
 665   3                              else if (system_stage == Stage_B)       //闭合安全开关
 666   3                              {
 667   4                                      if (isneedinitstage == 1)
 668   4                                      {
 669   5                                              #if UART_TEST
C51 COMPILER V9.54   MAIN                                                                  09/24/2019 22:21:40 PAGE 12  

 670   5                                              printf("init stage B\n");
 671   5                                              #endif
 672   5                                              isneedinitstage = 0;
 673   5                                              //init stage B
 674   5                                              dpdtime = 0;
 675   5                                              ischarging = 0;
 676   5                                              //check motor level                             
 677   5                                              LED_RGB_Setting(Motor_Level);
 678   5                                              if (Motor_Level == 0)
 679   5                                              {
 680   6                                                      LED_Setting(0);
 681   6                                                      isenableLED = 0;
 682   6                                              }
 683   5                                              else
 684   5                                              {
 685   6                                                      LED_Setting(system_stage);
 686   6                                                      isenableLED = 1;
 687   6                                              }
 688   5                                              led_display_time = 600;
 689   5                                              adccnt = 0;
 690   5                                              if (isfirstenterdpd == 1)
 691   5                                              adc_dis_cnt = 200;
 692   5                                      }
 693   4                                      if (keystatus & 0x01)//key
 694   4                                      {
 695   5                                              //change pwm
 696   5      //                                      if (adcvalue > 2400)
 697   5                                              {
 698   6                                                      Change_Motor_PWM();
 699   6                                                      #if UART_TEST
 700   6                                                      testtemp = Motor_Level;
 701   6                                                      printf("motor level=%d\n",testtemp);
 702   6                                                      #endif
 703   6                                                      LED_RGB_Setting(Motor_Level);
 704   6                                                      if (Motor_Level == 0)
 705   6                                                      {
 706   7                                                              LED_Setting(0);
 707   7                                                              isenableLED = 0;
 708   7                                                      }
 709   6                                                      else
 710   6                                                      {
 711   7                                                              LED_Setting(system_stage);
 712   7                                                              isenableLED = 1;
 713   7                                                      }
 714   6                                                      adccnt = 0;
 715   6                                                      if (isfirstenterdpd == 1)
 716   6                                                              adc_dis_cnt = 200;
 717   6                                                      dpdtime = 0;    
 718   6                                              }                                       
 719   5                                      }
 720   4                                      if (keystatus & 0x02)//safety
 721   4                                      {
 722   5                                      }
 723   4                                      else
 724   4                                      {
 725   5                                              system_stage = Stage_A;
 726   5                                              isneedinitstage = 1;
 727   5                                              //turn off pwm
 728   5                                              TurnOffMotor();
 729   5                                              LED_RGB_Setting(0);
 730   5                                              LED_Setting(0);
 731   5                                              isenableLED = 0;
C51 COMPILER V9.54   MAIN                                                                  09/24/2019 22:21:40 PAGE 13  

 732   5                                      }
 733   4                                      
 734   4                                      if (keystatus & 0x04)//charging
 735   4                                      {
 736   5                                              system_stage = Stage_D;
 737   5                                              isneedinitstage = 1;
 738   5                                      }
 739   4                                      
 740   4                                      if (keystatus & 0x08)
 741   4                                      {
 742   5                                              //turn off pwm
 743   5                                              TurnOffMotor();
 744   5                                              LED_RGB_Setting(0);
 745   5                                              LED_Setting(0);
 746   5                                              isenableLED = 0;
 747   5                                              adccnt = 0;
 748   5                                              if (isfirstenterdpd == 1)
 749   5                                                      adc_dis_cnt = 200;
 750   5                                              dpdtime = 0;
 751   5                                      }
 752   4                              }
 753   3                              else if (system_stage == Stage_C)       //充电中
 754   3                              {
 755   4                                      if (isneedinitstage == 1)
 756   4                                      {
 757   5                                              #if UART_TEST
 758   5                                              printf("init stage C\n");
 759   5                                              #endif
 760   5                                              isneedinitstage = 0;
 761   5                                              //init stage C  
 762   5                                              dpdtime = 0;
 763   5                                              ischarging = 1;                                 
 764   5                                              TurnOffMotor();
 765   5                                              LED_RGB_Setting(0);
 766   5                                              LED_Setting(system_stage);
 767   5                                              isenableLED = 1;
 768   5                                              led_display_time = 600;
 769   5                                              adccnt = 0;
 770   5                                              if (isfirstenterdpd == 1)
 771   5                                              adc_dis_cnt = 200;
 772   5                                      }
 773   4                                      if (keystatus & 0x01)//key
 774   4                                      {
 775   5                                              
 776   5                                      }
 777   4                                      if (keystatus & 0x02)//safety
 778   4                                      {
 779   5                                              //enter stage_B
 780   5                                              system_stage = Stage_D;
 781   5                                              isneedinitstage = 1;
 782   5                                      }
 783   4                                      
 784   4                                      if (keystatus & 0x04)//charging
 785   4                                      {
 786   5                                              dpdtime = 0;
 787   5                                      }
 788   4                                      else
 789   4                                      {
 790   5                                              system_stage = Stage_A;
 791   5                                              ischarging = 0;
 792   5                                              LED_Setting(0);
 793   5                                              isenableLED = 0;
C51 COMPILER V9.54   MAIN                                                                  09/24/2019 22:21:40 PAGE 14  

 794   5                                              isneedinitstage = 1;
 795   5                                      }
 796   4                              }
 797   3                              else if (system_stage == Stage_D)       //充电和闭合安全开关
 798   3                              {
 799   4                                      if (isneedinitstage == 1)
 800   4                                      {
 801   5                                              #if UART_TEST
 802   5                                              printf("init stage D\n");
 803   5                                              #endif
 804   5                                              isneedinitstage = 0;
 805   5                                              //init stage D
 806   5                                              dpdtime = 0;
 807   5                                              ischarging = 1;
 808   5                                              //check motor level                             
 809   5                                              LED_RGB_Setting(Motor_Level);
 810   5                                              LED_Setting(system_stage);
 811   5                                              isenableLED = 1;
 812   5                                              adccnt = 0;
 813   5                                              
 814   5                                              if (isfirstenterdpd == 1)
 815   5                                              adc_dis_cnt = 200;
 816   5                                      }
 817   4                                      if (keystatus & 0x01)//key
 818   4                                      {
 819   5                                              //change pwm
 820   5      //                                      if (adcvalue > 2400)
 821   5                                              {
 822   6                                                      Change_Motor_PWM();
 823   6                                                      #if UART_TEST
 824   6                                                      testtemp = Motor_Level;
 825   6                                                      printf("motor level=%d\n",testtemp);
 826   6                                                      #endif
 827   6                                                      LED_RGB_Setting(Motor_Level);
 828   6                                                      adccnt = 0;
 829   6                                                      if (isfirstenterdpd == 1)
 830   6                                                              adc_dis_cnt = 200;
 831   6                                                      dpdtime = 0;
 832   6                                              }
 833   5                                      }
 834   4                                      if (keystatus & 0x02)//safety
 835   4                                      {
 836   5                                      }
 837   4                                      else
 838   4                                      {
 839   5                                              system_stage = Stage_C;
 840   5                                              isneedinitstage = 1;
 841   5                                              TurnOffMotor();
 842   5                                              LED_RGB_Setting(0);
 843   5                                              LED_Setting(0);
 844   5                                              isenableLED = 0;
 845   5                                      }
 846   4                                      
 847   4                                      if (keystatus & 0x04)//charging
 848   4                                      {
 849   5                                              dpdtime = 0;
 850   5                                      }
 851   4                                      else
 852   4                                      {
 853   5                                              system_stage = Stage_B;
 854   5                                              ischarging = 0;
 855   5                                              LED_RGB_Setting(Motor_Level);
C51 COMPILER V9.54   MAIN                                                                  09/24/2019 22:21:40 PAGE 15  

 856   5                                              LED_Setting(system_stage);      
 857   5                                              isenableLED = 1;
 858   5                                              isneedinitstage = 1;
 859   5                                      }
 860   4                                      
 861   4                                      if (keystatus & 0x08)
 862   4                                      {
 863   5                                              //turn off pwm
 864   5                                              TurnOffMotor();
 865   5                                              LED_RGB_Setting(0);
 866   5                                              LED_Setting(system_stage);      
 867   5                                              isenableLED = 1;
 868   5                                              adccnt = 0;
 869   5                                              if (isfirstenterdpd == 1)
 870   5                                                      adc_dis_cnt = 200;
 871   5                                              dpdtime = 0;
 872   5                                      }
 873   4                              }
 874   3                              
 875   3                              //ADC process
 876   3      //                      if ((ischarging == 1)||(get_motor_level()!=0))
 877   3      //                              getbatlevel(200);
 878   3      //                      else
 879   3      //                              getbatlevel(2);
 880   3                              if (first_run_times < 1000)
 881   3                              {
 882   4                                      P06 = 0;
 883   4                              }
 884   3                              //ADC Porcess
 885   3                              if ((ischarging == 1) && (first_run_times > 1000))
 886   3                              {
 887   4                                      first_run_times = 1001;
 888   4                                      if (adc_wait_cnt == 1000)
 889   4                                      {
 890   5                                              //disable charging
 891   5                                              adc_wait_cnt = 1001;
 892   5                                              P06 = 0;        //disable chargine
 893   5                                      }
 894   4                                      else if (adc_wait_cnt >= 1050)
 895   4                                      {
 896   5                                              getbatlevel(0);
 897   5                                              P06 = 1;        //enable chargine
 898   5                                              adc_wait_cnt = 0;
 899   5                                      }
 900   4                              }
 901   3                              else if (get_motor_level()!=0)
 902   3                              {
 903   4                                      getbatlevel(80);
 904   4                              }
 905   3                              else
 906   3                              {
 907   4                                      getbatlevel(4);
 908   4                              }
 909   3                              
 910   3                              if (adc_dis_cnt > 0)
 911   3                                      adc_dis_cnt--;
 912   3                              
 913   3                              if (isWaitTurnOffCharging == 1)
 914   3                              {
 915   4                                      if (keystatus & 0x04)
 916   4                                      {
 917   5                                              batlevel = 6;
C51 COMPILER V9.54   MAIN                                                                  09/24/2019 22:21:40 PAGE 16  

 918   5                                      }
 919   4                                      else
 920   4                                      {
 921   5                                              isWaitTurnOffCharging = 0;
 922   5                                      }
 923   4                              }
 924   3                              //pwm rate
 925   3                              if (check_motor_done())
 926   3                              {
 927   4                                      #if UART_TEST
 928   4                                      printf("motor-locked,%d\n",__LINE__);
 929   4                                      #endif
 930   4                                      //turn off pwm
 931   4                                      TurnOffMotor();
 932   4                                      LED_RGB_Setting(0);
 933   4                                      isneedinitstage = 1;
 934   4                                      adccnt = 0;
 935   4                                      if (isfirstenterdpd == 1)
 936   4                                      adc_dis_cnt = 200;
 937   4                              }
 938   3                              if(Motor_Level)
 939   3                              {
 940   4                                      dpdtime = 0;
 941   4                              }
 942   3                              //LED_Process           
 943   3                              if (isenableLED)
 944   3                              LED_Process(system_stage);
 945   3                              
 946   3                              //dpd
 947   3                              if (dpdtime >= 2000)
 948   3                              {
 949   4                                      first_run_times = 0;
 950   4                                      isfirstenterdpd = 1;
 951   4                                      #if UART_TEST
 952   4                                      printf("enter dpd\n");
 953   4                                      #endif
 954   4                                      isfirstenterdpd = 1;
 955   4                                      Enter_DPD();
 956   4                              }
 957   3      //                      P13 = 1;
 958   3                              #if UART_TEST
 959   3      //                      if (dpdtime > 1000)
 960   3      //                      {
 961   3      //                              printf("test wdt reset\n");
 962   3      //                              while(1);
 963   3      //                      }
 964   3                              #endif
 965   3                              #if WDT_ENABLE
 966   3                              //clr wdt
 967   3                              set_WDCLR;
 968   3                              #endif
 969   3                      }
 970   2              }
 971   1      }
 972          
 973          void EXT_INT1(void) interrupt 2
 974          {
 975   1              
 976   1      }
 977          
 978          void PinInterrupt_ISR (void) interrupt 7
 979          {
C51 COMPILER V9.54   MAIN                                                                  09/24/2019 22:21:40 PAGE 17  

 980   1              if(PIF == 0x10) //pin 0
 981   1                      MOTOR_FG_PinInterrupt_ISR();
 982   1              PIF = 0x00;
 983   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2796    ----
   CONSTANT SIZE    =    186    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     42      22
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      8    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  3 WARNING(S),  0 ERROR(S)
